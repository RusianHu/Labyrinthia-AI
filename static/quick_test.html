<!DOCTYPE html>
<!-- 这个文件会是一个完整的测试界面文件，请不要分离它的 js 与 css -->
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>快速测试</title>
    <!-- Google Fonts & Material Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            /* 使用可无限拼接的背景瓦片 */
            background-color: #4a3a6b;
            background-image: url('/static/assets/bg-tile-dungeon.png');
            background-repeat: repeat;
            background-size: 256px 256px;
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            /* 半透明背景 + 微妙纹理 */
            background-color: rgba(255, 255, 255, 0.88);
            background-image: url('/static/assets/bg-panel-texture.png');
            background-repeat: repeat;
            background-size: 128px 128px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
        }

        .header {
            /* 使用带怪物剪影的黑暗地牢背景 */
            background-color: transparent;
            background-image: url('/static/assets/bg-header-monsters_1.png');
            background-repeat: no-repeat;
            background-size: 1024px 500px;
            background-position: center bottom;
            color: white;
            padding: 24px;
            text-align: center;
            position: relative;
            animation: pulse-jump 5s ease-in-out infinite;
            border: none;
            box-shadow: none;
            min-height: 350px; /* 调整容器高度以适应新的间距 */
            margin-bottom: 24px; /* 为下方内容留出正常间距，修复重叠 */
        }

        @keyframes pulse-jump {
            0%, 100% {
                background-size: 1024px 500px;
                background-position: center bottom;
            }
            50% {
                background-size: 1050px 512px; /* 略微放大 */
                background-position: center calc(bottom + 10px); /* 略微上移 */
            }
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg,
                rgba(255, 107, 107, 0.3) 0%,
                transparent 50%,
                rgba(0, 0, 0, 0.3) 100%);
            pointer-events: none;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            /* 增强文字可读性 */
            text-shadow:
                0 0 10px rgba(255, 107, 107, 0.8),
                0 0 20px rgba(255, 107, 107, 0.5),
                2px 2px 4px rgba(0, 0, 0, 0.9),
                4px 4px 8px rgba(0, 0, 0, 0.6);
            position: relative;
            z-index: 1;
        }

        .header .subtitle {
            font-size: 1.1rem;
            opacity: 1;
            text-shadow:
                2px 2px 4px rgba(0, 0, 0, 0.9),
                -1px -1px 2px rgba(0, 0, 0, 0.7);
            position: relative;
            z-index: 1;
        }

        .content {
            padding: 24px;
        }

        .test-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .test-category {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .category-title {
            display: flex;
            align-items: center;
            font-size: 1.2rem;
            font-weight: 500;
            color: #333;
            margin-bottom: 16px;
        }

        .category-title .material-icons {
            margin-right: 8px;
            color: #667eea;
        }

        .test-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .test-btn {
            display: flex;
            align-items: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: left;
        }

        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .test-btn:active {
            transform: translateY(0);
        }

        .test-btn .material-icons {
            margin-right: 8px;
            font-size: 18px;
        }

        .test-btn.secondary {
            background: linear-gradient(135deg, #ffa726, #ff7043);
        }

        .test-btn.secondary:hover {
            box-shadow: 0 6px 20px rgba(255, 167, 38, 0.4);
        }

        .test-btn.danger {
            background: linear-gradient(135deg, #ef5350, #e91e63);
        }

        .test-btn.danger:hover {
            box-shadow: 0 6px 20px rgba(239, 83, 80, 0.4);
        }

        .results-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .results-title {
            display: flex;
            align-items: center;
            font-size: 1.2rem;
            font-weight: 500;
            color: #333;
            margin-bottom: 16px;
        }

        .results-title .material-icons {
            margin-right: 8px;
            color: #667eea;
        }

        .result {
            margin: 8px 0;
            padding: 12px 16px;
            border-radius: 8px;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.9rem;
            border-left: 4px solid;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .success {
            background: #e8f5e8;
            color: #2e7d32;
            border-left-color: #4caf50;
        }

        .error {
            background: #ffeaea;
            color: #c62828;
            border-left-color: #f44336;
        }

        .info {
            background: #e3f2fd;
            color: #1565c0;
            border-left-color: #2196f3;
        }

        .warning {
            background: #fff8e1;
            color: #ef6c00;
            border-left-color: #ff9800;
        }

        .clear-btn {
            background: linear-gradient(135deg, #78909c, #546e7a);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .clear-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(120, 144, 156, 0.4);
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .test-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        @media (max-width: 768px) {
            .header {
                margin-bottom: 20px; /* 移除负边距，设置一个合适的正边距 */
                min-height: 250px; /* 调整高度以适应移动端 */
                background-size: cover; /* 让背景图片覆盖整个容器 */
                background-position: center top; /* 调整背景图片位置 */
            }

            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧪 Labyrinthia AI 测试中心</h1>
            <div class="subtitle">全面的游戏功能测试与调试工具</div>
        </div>

        <div class="content">
            <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                <a class="clear-btn" href="/particle_test.html" target="_blank">
                    <span class="material-icons" style="font-size: 14px; margin-right: 4px;">auto_awesome</span>
                    打开粒子特效测试页面
                </a>
            </div>
            <!-- 测试分类 -->
            <div class="test-categories">
                <!-- 基础功能测试 -->
                <div class="test-category">
                    <div class="category-title">
                        <span class="material-icons">settings</span>
                        基础功能测试
                    </div>
                    <div class="test-buttons">
                        <button class="test-btn" onclick="testBasicFunctionality()">
                            <span class="material-icons">check_circle</span>
                            基础功能检查
                        </button>
                        <button class="test-btn" onclick="testGameInitialization()">
                            <span class="material-icons">play_arrow</span>
                            游戏初始化测试
                        </button>
                        <button class="test-btn" onclick="testConfigLoading()">
                            <span class="material-icons">settings_applications</span>
                            配置加载测试
                        </button>
                    </div>
                </div>

                <!-- LLM API测试 -->
                <div class="test-category">
                    <div class="category-title">
                        <span class="material-icons">cloud</span>
                        LLM API 测试
                    </div>
                    <div class="test-buttons">
                        <button class="test-btn" onclick="testGeminiConnection()">
                            <span class="material-icons">link</span>
                            Gemini API 连接
                        </button>
                        <button class="test-btn" onclick="testOpenRouterConnection()">
                            <span class="material-icons">router</span>
                            OpenRouter API 连接
                        </button>
                        <button class="test-btn" onclick="testContentGeneration()">
                            <span class="material-icons">auto_awesome</span>
                            内容生成测试
                        </button>
                    </div>
                </div>

                <!-- 游戏核心功能测试 -->
                <div class="test-category">
                    <div class="category-title">
                        <span class="material-icons">videogame_asset</span>
                        游戏核心功能
                    </div>
                    <div class="test-buttons">
                        <button class="test-btn" onclick="testMapGeneration()">
                            <span class="material-icons">map</span>
                            地图生成测试
                        </button>
                        <button class="test-btn" onclick="testCharacterSystem()">
                            <span class="material-icons">person</span>
                            角色系统测试
                        </button>
                        <button class="test-btn" onclick="testQuestSystem()">
                            <span class="material-icons">assignment</span>
                            任务系统测试
                        </button>
                        <button class="test-btn" onclick="testItemSystem()">
                            <span class="material-icons">inventory</span>
                            物品系统测试
                        </button>
                    </div>
                </div>

                <!-- 事件选择系统测试 -->
                <div class="test-category">
                    <div class="category-title">
                        <span class="material-icons">psychology</span>
                        事件选择系统测试
                    </div>
                    <div class="test-buttons">
                        <button class="test-btn" onclick="testEventChoiceSystem()">
                            <span class="material-icons">quiz</span>
                            事件选择系统检查
                        </button>
                        <button class="test-btn" onclick="testStoryEventGeneration()">
                            <span class="material-icons">auto_stories</span>
                            故事事件生成测试
                        </button>
                        <button class="test-btn" onclick="testQuestCompletionChoice()">
                            <span class="material-icons">task_alt</span>
                            任务完成选择测试
                        </button>
                        <button class="test-btn" onclick="testChoiceProcessing()">
                            <span class="material-icons">settings_suggest</span>
                            选择处理测试
                        </button>
                        <button class="test-btn" onclick="testLLMPermissions()">
                            <span class="material-icons">admin_panel_settings</span>
                            LLM权限测试
                        </button>
                        <button class="test-btn" onclick="testContextInformation()">
                            <span class="material-icons">info</span>
                            上下文信息测试
                        </button>
                    </div>
                </div>

                <!-- 数据管理测试 -->
                <div class="test-category">
                    <div class="category-title">
                        <span class="material-icons">storage</span>
                        数据管理测试
                    </div>
                    <div class="test-buttons">
                        <button class="test-btn" onclick="testDataSaving()">
                            <span class="material-icons">save</span>
                            数据保存测试
                        </button>
                        <button class="test-btn" onclick="testDataLoading()">
                            <span class="material-icons">folder_open</span>
                            数据加载测试
                        </button>
                        <button class="test-btn" onclick="testGameStateManagement()">
                            <span class="material-icons">manage_accounts</span>
                            游戏状态管理
                        </button>
                        <button class="test-btn" onclick="testDebugForceLoad()">
                            <span class="material-icons">upload_file</span>
                            调试强制加载测试
                        </button>
                    </div>
                </div>

                <!-- 调试功能 -->
                <div class="test-category">
                    <div class="category-title">
                        <span class="material-icons">bug_report</span>
                        调试功能
                    </div>
                    <div class="test-buttons">
                        <button class="test-btn secondary" onclick="testDebugMethods()">
                            <span class="material-icons">build</span>
                            调试方法测试
                        </button>
                        <button class="test-btn secondary" onclick="integrateDebugFeatures()">
                            <span class="material-icons">integration_instructions</span>
                            集成调试功能
                        </button>
                        <button class="test-btn secondary" onclick="testDebugPanelToggle()">
                            <span class="material-icons">dashboard</span>
                            调试面板切换
                        </button>
                        <button class="test-btn secondary" onclick="testDebugModeCheck()">
                            <span class="material-icons">settings</span>
                            调试模式检查
                        </button>
                        <button class="test-btn secondary" onclick="triggerTestEvent()">
                            <span class="material-icons">event</span>
                            触发测试事件
                        </button>
                        <button class="test-btn secondary" onclick="showGameState()">
                            <span class="material-icons">info</span>
                            显示游戏状态
                        </button>
                    </div>
                </div>

                <!-- 压力测试 -->
                <div class="test-category">
                    <div class="category-title">
                        <span class="material-icons">speed</span>
                        性能与压力测试
                    </div>
                    <div class="test-buttons">
                        <button class="test-btn danger" onclick="runStressTest()">
                            <span class="material-icons">flash_on</span>
                            API 压力测试
                        </button>
                        <button class="test-btn danger" onclick="testMemoryUsage()">
                            <span class="material-icons">memory</span>
                            内存使用测试
                        </button>
                        <button class="test-btn danger" onclick="runFullSystemTest()">
                            <span class="material-icons">system_update_alt</span>
                            完整系统测试
                        </button>
                    </div>
                </div>
            </div>

            <!-- 测试结果显示区域 -->
            <div class="results-section">
                <div class="results-title">
                    <span class="material-icons">assessment</span>
                    测试结果
                </div>
                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                    <button class="clear-btn" onclick="clearResults()">
                        <span class="material-icons" style="font-size: 14px; margin-right: 4px;">clear</span>
                        清空结果
                    </button>
                    <button class="clear-btn" onclick="generateTestReport()">
                        <span class="material-icons" style="font-size: 14px; margin-right: 4px;">assessment</span>
                        生成报告
                    </button>
                    <button class="clear-btn" onclick="exportTestResults()">
                        <span class="material-icons" style="font-size: 14px; margin-right: 4px;">download</span>
                        导出结果
                    </button>
                </div>
                <div id="results"></div>
            </div>
        </div>
    </div>

    <!-- 加载游戏脚本 - 按依赖顺序加载 -->
    <script src="/static/GameCore.js"></script>
    <script src="/static/EventHandler.js"></script>
    <script src="/static/UIManager.js"></script>
    <script src="/static/SaveManager.js"></script>
    <script src="/static/OverlayManager.js"></script>
    <script src="/static/EffectsManager.js"></script>
    <script src="/static/MapInteraction.js"></script>
    <script src="/static/GameActions.js"></script>
    <script src="/static/EventChoiceManager.js"></script>
    <script src="/static/DebugManager.js"></script>

    <script>
        // 全局变量
        let testGame = null;
        let testResults = [];

        // 工具函数
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;

            // 记录到测试结果数组
            testResults.push({
                timestamp: new Date(),
                message: message,
                type: type
            });
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            testResults = [];
            log('测试结果已清空', 'info');
        }

        function setButtonLoading(button, loading = true) {
            if (loading) {
                button.disabled = true;
                const originalText = button.innerHTML;
                button.setAttribute('data-original-text', originalText);
                button.innerHTML = '<span class="loading"></span>测试中...';
            } else {
                button.disabled = false;
                const originalText = button.getAttribute('data-original-text');
                if (originalText) {
                    button.innerHTML = originalText;
                }
            }
        }

        async function withLoadingButton(button, asyncFunction) {
            setButtonLoading(button, true);
            try {
                await asyncFunction();
            } catch (error) {
                log(`测试过程中发生错误: ${error.message}`, 'error');
            } finally {
                setButtonLoading(button, false);
            }
        }

        // ==================== 基础功能测试 ====================

        async function testBasicFunctionality() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始基础功能检查...', 'info');

                // 检查核心类和函数是否存在
                const coreItems = [
                    { name: 'LabyrinthiaGame', type: 'class' },
                    { name: 'addDebugMethodsToGame', type: 'function' }
                ];

                let allItemsExist = true;
                coreItems.forEach(item => {
                    let exists = false;
                    let correctType = false;

                    if (item.name === 'LabyrinthiaGame') {
                        // 特殊检查 LabyrinthiaGame 类
                        exists = typeof LabyrinthiaGame !== 'undefined';
                        correctType = exists && typeof LabyrinthiaGame === 'function' && LabyrinthiaGame.prototype;

                        // 额外检查：是否有游戏实例存在
                        if (exists && window.game instanceof LabyrinthiaGame) {
                            log(`✅ ${item.name} (${item.type}) 已定义且实例已创建`, 'success');
                            return;
                        }
                    } else {
                        // 检查其他函数
                        exists = typeof window[item.name] !== 'undefined';
                        correctType = exists && typeof window[item.name] === 'function';
                    }

                    if (exists && correctType) {
                        log(`✅ ${item.name} (${item.type}) 已定义`, 'success');
                    } else if (exists) {
                        log(`⚠️ ${item.name} 已定义但类型不匹配`, 'warning');
                        allItemsExist = false;
                    } else {
                        log(`❌ ${item.name} (${item.type}) 未定义`, 'error');
                        allItemsExist = false;
                    }
                });

                if (allItemsExist) {
                    log('🎉 所有核心组件检查通过！', 'success');
                } else {
                    log('⚠️ 部分核心组件缺失，可能影响游戏功能', 'warning');
                }
            });
        }

        async function testGameInitialization() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始游戏初始化测试...', 'info');

                try {
                    if (typeof LabyrinthiaGame === 'undefined') {
                        log('❌ LabyrinthiaGame 类未定义', 'error');
                        return;
                    }

                    // 创建测试游戏实例
                    testGame = new LabyrinthiaGame();
                    log('✅ 游戏实例创建成功', 'success');

                    // 检查基础属性
                    const requiredProperties = [
                        'gameId', 'gameState', 'isLoading', 'messageLog',
                        'debugMode', 'config'
                    ];

                    let allPropertiesExist = true;
                    requiredProperties.forEach(prop => {
                        if (testGame.hasOwnProperty(prop)) {
                            log(`✅ 属性 ${prop} 存在`, 'success');
                        } else {
                            log(`❌ 属性 ${prop} 不存在`, 'error');
                            allPropertiesExist = false;
                        }
                    });

                    // 检查基础方法
                    const requiredMethods = [
                        'init', 'loadConfig', 'initializeDebugMode',
                        'refreshGameState', 'updateUI'
                    ];

                    let allMethodsExist = true;
                    requiredMethods.forEach(method => {
                        if (typeof testGame[method] === 'function') {
                            log(`✅ 方法 ${method} 存在`, 'success');
                        } else {
                            log(`❌ 方法 ${method} 不存在`, 'error');
                            allMethodsExist = false;
                        }
                    });

                    if (allPropertiesExist && allMethodsExist) {
                        log('🎉 游戏初始化测试通过！', 'success');
                    } else {
                        log('⚠️ 游戏初始化存在问题', 'warning');
                    }

                } catch (error) {
                    log(`❌ 游戏初始化失败: ${error.message}`, 'error');
                }
            });
        }

        async function testConfigLoading() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始配置加载测试...', 'info');

                try {
                    const response = await fetch('/api/config');
                    if (response.ok) {
                        const payload = await response.json();
                        const cfg = payload?.config || payload; // 兼容历史结构
                        log('✅ 配置文件加载成功', 'success');
                        log(`📊 游戏名称: ${cfg.game?.game_name || '未知'}`, 'info');
                        log(`📊 调试模式: ${cfg.game?.debug_mode ? '启用' : '禁用'}`, 'info');
                        log(`📊 LLM提供商: ${cfg.llm?.provider || '未知'}`, 'info');
                    } else {
                        log(`❌ 配置加载失败: HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`❌ 配置加载异常: ${error.message}`, 'error');
                }
            });
        }

        // ==================== LLM API 测试 ====================

        async function testGeminiConnection() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始 Gemini API 连接测试...', 'info');

                try {
                    const response = await fetch('/api/test/gemini', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ test_message: '这是一个连接测试' })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            log('✅ Gemini API 连接成功', 'success');
                            log(`📝 响应: ${result.response || '无响应内容'}`, 'info');
                        } else {
                            log(`❌ Gemini API 测试失败: ${result.message}`, 'error');
                        }
                    } else {
                        log(`❌ Gemini API 请求失败: HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`❌ Gemini API 连接异常: ${error.message}`, 'error');
                }
            });
        }

        async function testOpenRouterConnection() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始 OpenRouter API 连接测试...', 'info');

                try {
                    const response = await fetch('/api/test/openrouter', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ test_message: '这是一个连接测试' })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            log('✅ OpenRouter API 连接成功', 'success');
                            log(`📝 响应: ${result.response || '无响应内容'}`, 'info');
                        } else {
                            log(`❌ OpenRouter API 测试失败: ${result.message}`, 'error');
                        }
                    } else {
                        log(`❌ OpenRouter API 请求失败: HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`❌ OpenRouter API 连接异常: ${error.message}`, 'error');
                }
            });
        }

        async function testContentGeneration() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始内容生成测试...', 'info');

                try {
                    const response = await fetch('/api/test/content-generation', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            test_type: 'simple_item',
                            player_level: 1
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            log('✅ 内容生成测试成功', 'success');
                            log(`📦 生成内容类型: ${result.content_type || '未知'}`, 'info');
                            if (result.generated_content) {
                                log(`📝 生成内容: ${JSON.stringify(result.generated_content).substring(0, 100)}...`, 'info');
                            }
                        } else {
                            log(`❌ 内容生成测试失败: ${result.message}`, 'error');
                        }
                    } else {
                        log(`❌ 内容生成请求失败: HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`❌ 内容生成测试异常: ${error.message}`, 'error');
                }
            });
        }

        // ==================== 事件选择系统测试 ====================

        async function testEventChoiceSystem() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始事件选择系统检查...', 'info');

                try {
                    // 检查事件选择管理器是否存在
                    if (typeof EventChoiceManager !== 'undefined') {
                        log('✅ EventChoiceManager 类存在', 'success');
                    } else {
                        log('❌ EventChoiceManager 类不存在', 'error');
                    }

                    // 检查事件选择系统API
                    const response = await fetch('/api/test/event-choice-system', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ test_type: 'system_check' })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            log('✅ 事件选择系统API可用', 'success');
                            log(`📊 支持的事件类型: ${result.supported_event_types?.length || 0} 种`, 'info');
                            log(`🔧 注册的处理器: ${result.registered_handlers || 0} 个`, 'info');
                            log(`📝 活跃上下文: ${result.active_contexts || 0} 个`, 'info');
                        } else {
                            log(`❌ 事件选择系统检查失败: ${result.message}`, 'error');
                        }
                    } else {
                        log(`❌ 事件选择系统API请求失败: HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`❌ 事件选择系统检查异常: ${error.message}`, 'error');
                }
            });
        }

        async function testStoryEventGeneration() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始故事事件生成测试...', 'info');

                try {
                    const response = await fetch('/api/test/story-event-generation', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            test_type: 'story_event',
                            player_level: 1,
                            map_depth: 1,
                            has_active_quest: true
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            log('✅ 故事事件生成成功', 'success');
                            log(`📖 事件标题: ${result.event_title || '未知'}`, 'info');
                            log(`📝 事件描述: ${result.event_description?.substring(0, 50) || '无'}...`, 'info');
                            log(`🎯 选择数量: ${result.choices_count || 0} 个`, 'info');
                            log(`🔗 上下文ID: ${result.context_id || '无'}`, 'info');
                        } else {
                            log(`❌ 故事事件生成失败: ${result.message}`, 'error');
                        }
                    } else {
                        log(`❌ 故事事件生成请求失败: HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`❌ 故事事件生成测试异常: ${error.message}`, 'error');
                }
            });
        }

        async function testQuestCompletionChoice() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始任务完成选择测试...', 'info');

                try {
                    const response = await fetch('/api/test/quest-completion-choice', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            test_type: 'quest_completion',
                            quest_title: '测试任务',
                            quest_type: 'exploration',
                            player_level: 1
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            log('✅ 任务完成选择生成成功', 'success');
                            log(`🏆 完成标题: ${result.completion_title || '未知'}`, 'info');
                            log(`📝 完成描述: ${result.completion_description?.substring(0, 50) || '无'}...`, 'info');
                            log(`🎯 后续选择: ${result.choices_count || 0} 个`, 'info');
                            log(`🔗 上下文ID: ${result.context_id || '无'}`, 'info');
                        } else {
                            log(`❌ 任务完成选择测试失败: ${result.message}`, 'error');
                        }
                    } else {
                        log(`❌ 任务完成选择请求失败: HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`❌ 任务完成选择测试异常: ${error.message}`, 'error');
                }
            });
        }

        async function testChoiceProcessing() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始选择处理测试...', 'info');

                try {
                    const response = await fetch('/api/test/choice-processing', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            test_type: 'choice_processing',
                            choice_text: '仔细调查',
                            event_type: 'story_event'
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            log('✅ 选择处理测试成功', 'success');
                            log(`📝 处理结果: ${result.result_message || '无'}`, 'info');
                            log(`🎭 触发事件: ${result.triggered_events || 0} 个`, 'info');
                            log(`🗺️ 地图更新: ${result.map_updates ? '是' : '否'}`, 'info');
                            log(`👤 玩家更新: ${result.player_updates ? '是' : '否'}`, 'info');
                            log(`📜 任务更新: ${result.quest_updates ? '是' : '否'}`, 'info');
                        } else {
                            log(`❌ 选择处理测试失败: ${result.message}`, 'error');
                        }
                    } else {
                        log(`❌ 选择处理请求失败: HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`❌ 选择处理测试异常: ${error.message}`, 'error');
                }
            });
        }

        async function testLLMPermissions() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始LLM权限测试...', 'info');

                try {
                    const response = await fetch('/api/test/llm-permissions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            test_type: 'permissions_check',
                            test_permissions: [
                                'terrain_modification',
                                'monster_management',
                                'event_creation',
                                'item_addition',
                                'player_attributes',
                                'quest_progress',
                                'narrative_content'
                            ]
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            log('✅ LLM权限测试成功', 'success');

                            const permissions = result.permission_results || {};
                            Object.entries(permissions).forEach(([permission, status]) => {
                                const icon = status ? '✅' : '❌';
                                const type = status ? 'success' : 'error';
                                log(`${icon} ${permission}: ${status ? '支持' : '不支持'}`, type);
                            });

                            const supportedCount = Object.values(permissions).filter(Boolean).length;
                            const totalCount = Object.keys(permissions).length;
                            log(`📊 权限支持率: ${supportedCount}/${totalCount} (${((supportedCount/totalCount)*100).toFixed(1)}%)`, 'info');
                        } else {
                            log(`❌ LLM权限测试失败: ${result.message}`, 'error');
                        }
                    } else {
                        log(`❌ LLM权限请求失败: HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`❌ LLM权限测试异常: ${error.message}`, 'error');
                }
            });
        }

        async function testContextInformation() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始上下文信息测试...', 'info');

                try {
                    const response = await fetch('/api/test/context-information', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            test_type: 'context_check',
                            include_player_info: true,
                            include_map_info: true,
                            include_quest_info: true,
                            include_event_info: true
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            log('✅ 上下文信息测试成功', 'success');

                            const context = result.context_data || {};
                            log(`👤 玩家信息: ${context.player_info ? '包含' : '缺失'}`, context.player_info ? 'success' : 'warning');
                            log(`🗺️ 地图信息: ${context.map_info ? '包含' : '缺失'}`, context.map_info ? 'success' : 'warning');
                            log(`📜 任务信息: ${context.quest_info ? '包含' : '缺失'}`, context.quest_info ? 'success' : 'warning');
                            log(`🎭 事件信息: ${context.event_info ? '包含' : '缺失'}`, context.event_info ? 'success' : 'warning');

                            if (context.detailed_info) {
                                log(`📊 详细信息字段: ${Object.keys(context.detailed_info).length} 个`, 'info');
                                Object.keys(context.detailed_info).forEach(field => {
                                    log(`   📋 ${field}`, 'info');
                                });
                            }
                        } else {
                            log(`❌ 上下文信息测试失败: ${result.message}`, 'error');
                        }
                    } else {
                        log(`❌ 上下文信息请求失败: HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`❌ 上下文信息测试异常: ${error.message}`, 'error');
                }
            });
        }

        // ==================== 游戏核心功能测试 ====================

        async function testMapGeneration() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始地图生成测试...', 'info');

                try {
                    const response = await fetch('/api/test/map-generation', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            width: 10,
                            height: 10,
                            depth: 1,
                            theme: '测试地下城'
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            log('✅ 地图生成测试成功', 'success');
                            log(`🗺️ 地图名称: ${result.map_name || '未知'}`, 'info');
                            log(`📏 地图尺寸: ${result.map_size || '未知'}`, 'info');
                            log(`🏠 房间数量: ${result.room_count || 0}`, 'info');
                            log(`⭐ 特殊事件: ${result.event_count || 0}`, 'info');
                        } else {
                            log(`❌ 地图生成测试失败: ${result.message}`, 'error');
                        }
                    } else {
                        log(`❌ 地图生成请求失败: HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`❌ 地图生成测试异常: ${error.message}`, 'error');
                }
            });
        }

        async function testCharacterSystem() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始角色系统测试...', 'info');

                try {
                    const response = await fetch('/api/test/character-system', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            character_name: '测试角色',
                            character_class: 'warrior'
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            log('✅ 角色系统测试成功', 'success');
                            log(`👤 角色名称: ${result.character_name || '未知'}`, 'info');
                            log(`⚔️ 角色职业: ${result.character_class || '未知'}`, 'info');
                            log(`📊 属性统计: ${result.stats_summary || '无'}`, 'info');
                        } else {
                            log(`❌ 角色系统测试失败: ${result.message}`, 'error');
                        }
                    } else {
                        log(`❌ 角色系统请求失败: HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`❌ 角色系统测试异常: ${error.message}`, 'error');
                }
            });
        }

        async function testQuestSystem() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始任务系统测试...', 'info');

                try {
                    const response = await fetch('/api/test/quest-system', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            player_level: 1,
                            quest_type: 'exploration'
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            log('✅ 任务系统测试成功', 'success');
                            log(`📜 任务标题: ${result.quest_title || '未知'}`, 'info');
                            log(`🎯 任务类型: ${result.quest_type || '未知'}`, 'info');
                            log(`🏆 目标楼层: ${result.target_floors || '未知'}`, 'info');
                            log(`⭐ 专属事件: ${result.special_events_count || 0} 个`, 'info');
                        } else {
                            log(`❌ 任务系统测试失败: ${result.message}`, 'error');
                        }
                    } else {
                        log(`❌ 任务系统请求失败: HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`❌ 任务系统测试异常: ${error.message}`, 'error');
                }
            });
        }

        async function testItemSystem() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始物品系统测试...', 'info');

                try {
                    const response = await fetch('/api/test/item-system', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            item_type: 'weapon',
                            player_level: 1
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            log('✅ 物品系统测试成功', 'success');
                            log(`🎒 物品名称: ${result.item_name || '未知'}`, 'info');
                            log(`🏷️ 物品类型: ${result.item_type || '未知'}`, 'info');
                            log(`💎 物品品质: ${result.item_rarity || '未知'}`, 'info');
                            log(`📝 物品描述: ${result.item_description?.substring(0, 50) || '无'}...`, 'info');
                        } else {
                            log(`❌ 物品系统测试失败: ${result.message}`, 'error');
                        }
                    } else {
                        log(`❌ 物品系统请求失败: HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`❌ 物品系统测试异常: ${error.message}`, 'error');
                }
            });
        }

        // 页面加载完成后初始化测试环境（不自动运行测试）
        window.addEventListener('load', () => {
            initializeTestEnvironment();
        });

        function initializeTestEnvironment() {
            log('🚀 测试环境已准备就绪，选择测试功能开始测试', 'info');
            log('💡 提示：不同颜色的按钮代表不同类型的测试', 'info');
            log('⌨️ 快捷键：Ctrl+R=生成报告, Ctrl+E=导出结果, Ctrl+L=清空', 'info');
            log('🖱️ 右键点击结果区域可显示更多选项', 'info');

            // 检查是否有现有的游戏实例
            if (window.game) {
                log('🎮 检测到现有游戏实例，可以进行高级测试', 'success');
                testGame = window.game;
            } else {
                // 创建一个测试用的游戏实例
                try {
                    if (typeof LabyrinthiaGame !== 'undefined') {
                        window.game = new LabyrinthiaGame();
                        testGame = window.game;
                        log('🎮 已创建测试游戏实例', 'success');
                    } else {
                        log('⚠️ LabyrinthiaGame 类未加载，稍后重试...', 'warning');
                        // 延迟重试
                        setTimeout(() => {
                            if (typeof LabyrinthiaGame !== 'undefined') {
                                window.game = new LabyrinthiaGame();
                                testGame = window.game;
                                log('🎮 已创建测试游戏实例 (延迟)', 'success');

                                // 重新尝试添加调试方法
                                if (typeof addDebugMethodsToGame === 'function') {
                                    try {
                                        addDebugMethodsToGame(testGame);
                                        log('🔧 调试方法已集成到测试环境 (延迟)', 'success');
                                    } catch (error) {
                                        log(`⚠️ 调试方法集成失败: ${error.message}`, 'warning');
                                    }
                                }
                            }
                        }, 500);
                    }
                } catch (error) {
                    log(`❌ 创建游戏实例失败: ${error.message}`, 'error');
                }
            }

            // 添加调试功能集成
            if (typeof addDebugMethodsToGame === 'function' && testGame) {
                try {
                    addDebugMethodsToGame(testGame);
                    log('🔧 调试方法已集成到测试环境', 'success');
                } catch (error) {
                    log(`⚠️ 调试方法集成失败: ${error.message}`, 'warning');
                }

            // 调试模式门控：非调试模式禁用测试按钮
            gateByDebugMode();
            }
        }

        // ==================== 调试功能集成 ====================

        //  调试模式门控函数
        function gateByDebugMode() {
            try {
                fetch('/api/config')
                    .then(res => res.json())
                    .then(payload => {
                        const cfg = payload?.config || payload;
                        const debug = cfg?.game?.debug_mode;
                        if (!debug) {
                            document.querySelectorAll('.test-btn, .clear-btn').forEach(btn => btn.disabled = true);

                            log(' 调试模式未启用：快速测试功能已禁用', 'warning');
                        }
                    })
                    .catch(err => {
                        log(` 调试模式检测失败: ${err.message}`, 'warning');
                    });
            } catch (e) {
                log(` 调试模式检测异常: ${e.message}`, 'warning');
            }
        }


        async function integrateDebugFeatures() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始集成调试功能...', 'info');

                try {
                    // 检查调试管理器是否可用
                    if (typeof DebugMethods !== 'undefined') {
                        log('✅ DebugMethods 对象可用', 'success');

                        // 列出可用的调试方法
                        const debugMethodNames = Object.getOwnPropertyNames(DebugMethods);
                        log(`📋 可用调试方法: ${debugMethodNames.length} 个`, 'info');

                        debugMethodNames.forEach(methodName => {
                            if (typeof DebugMethods[methodName] === 'function') {
                                log(`   🔧 ${methodName}`, 'info');
                            }
                        });

                        // 如果有测试游戏实例，添加调试方法
                        if (testGame) {
                            Object.assign(testGame, DebugMethods);
                            log('✅ 调试方法已添加到测试游戏实例', 'success');
                        }

                    } else {
                        log('❌ DebugMethods 对象不可用', 'error');
                    }

                    // 检查调试面板是否存在
                    const debugPanel = document.getElementById('debug-panel');
                    if (debugPanel) {
                        log('✅ 调试面板元素存在', 'success');
                    } else {
                        log('⚠️ 调试面板元素不存在', 'warning');
                    }

                    // 检查调试FAB按钮
                    const debugFab = document.getElementById('debug-fab');
                    if (debugFab) {
                        log('✅ 调试FAB按钮存在', 'success');
                    } else {
                        log('⚠️ 调试FAB按钮不存在', 'warning');
                    }

                } catch (error) {
                    log(`❌ 调试功能集成异常: ${error.message}`, 'error');
                }
            });
        }

        async function testDebugPanelToggle() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('测试调试面板切换功能...', 'info');

                try {
                    if (testGame && typeof testGame.toggleDebugPanel === 'function') {
                        testGame.toggleDebugPanel();
                        log('✅ 调试面板切换成功', 'success');

                        // 检查面板状态
                        const debugPanel = document.getElementById('debug-panel');
                        if (debugPanel) {
                            const isVisible = debugPanel.style.display !== 'none';
                            log(`📊 调试面板状态: ${isVisible ? '显示' : '隐藏'}`, 'info');
                        }
                    } else {
                        log('❌ 调试面板切换功能不可用', 'error');
                    }
                } catch (error) {
                    log(`❌ 调试面板切换测试失败: ${error.message}`, 'error');
                }
            });
        }

        async function testDebugModeCheck() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('检查调试模式状态...', 'info');

                try {
                    // 检查配置中的调试模式
                    const response = await fetch('/api/config');
                    if (response.ok) {
                        const config = await response.json();
                        const debugMode = config.config?.game?.debug_mode;
                        const showLLMDebug = config.config?.game?.show_llm_debug;

                        log(`🔧 调试模式: ${debugMode ? '启用' : '禁用'}`, debugMode ? 'success' : 'warning');
                        log(`🤖 LLM调试: ${showLLMDebug ? '启用' : '禁用'}`, showLLMDebug ? 'success' : 'info');

                        if (testGame) {
                            log(`🎮 游戏实例调试模式: ${testGame.debugMode ? '启用' : '禁用'}`, testGame.debugMode ? 'success' : 'info');
                        }
                    }

                    // 检查调试状态函数
                    if (typeof window.checkDebugStatus === 'function') {
                        window.checkDebugStatus();
                        log('✅ 调试状态检查函数已执行', 'success');
                    } else {
                        log('⚠️ 调试状态检查函数不存在', 'warning');
                    }

                } catch (error) {
                    log(`❌ 调试模式检查失败: ${error.message}`, 'error');
                }
            });
        }

        // ==================== 数据管理测试 ====================

        async function testDataSaving() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始数据保存测试...', 'info');

                try {
                    const testData = {
                        test_save: true,
                        timestamp: new Date().toISOString(),
                        player_name: '测试玩家',
                        level: 1
                    };

                    const response = await fetch('/api/test/data-saving', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(testData)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            log('✅ 数据保存测试成功', 'success');
                            log(`💾 保存文件: ${result.save_file || '未知'}`, 'info');
                            log(`📊 数据大小: ${result.data_size || '未知'}`, 'info');
                        } else {
                            log(`❌ 数据保存测试失败: ${result.message}`, 'error');
                        }
                    } else {
                        log(`❌ 数据保存请求失败: HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`❌ 数据保存测试异常: ${error.message}`, 'error');
                }
            });
        }

        async function testDataLoading() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始数据加载测试...', 'info');

                try {
                    const response = await fetch('/api/test/data-loading', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ test_load: true })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            log('✅ 数据加载测试成功', 'success');
                            log(`📂 可用存档: ${result.save_count || 0} 个`, 'info');
                            log(`📊 最新存档: ${result.latest_save || '无'}`, 'info');
                        } else {
                            log(`❌ 数据加载测试失败: ${result.message}`, 'error');
                        }
                    } else {
                        log(`❌ 数据加载请求失败: HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`❌ 数据加载测试异常: ${error.message}`, 'error');
                }
            });
        }

        async function testGameStateManagement() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始游戏状态管理测试...', 'info');

                try {
                    const response = await fetch('/api/test/gamestate-management', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ test_gamestate: true })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            log('✅ 游戏状态管理测试成功', 'success');
                            log(`🎮 活跃游戏: ${result.active_games || 0} 个`, 'info');
                            log(`💾 状态同步: ${result.sync_status || '未知'}`, 'info');
                        } else {
                            log(`❌ 游戏状态管理测试失败: ${result.message}`, 'error');
                        }
                    } else {
                        log(`❌ 游戏状态管理请求失败: HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`❌ 游戏状态管理测试异常: ${error.message}`, 'error');
                }
            });
        }

        // ==================== 调试功能测试 ====================

        async function testDebugMethods() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始调试方法测试...', 'info');

                try {
                    // 检查调试方法是否存在
                    if (typeof addDebugMethodsToGame === 'function') {
                        log('✅ addDebugMethodsToGame 函数存在', 'success');

                        if (testGame) {
                            // 添加调试方法到测试游戏实例
                            addDebugMethodsToGame(testGame);

                            // 检查调试方法
                            const debugMethods = [
                                'debugTriggerRandomEvent',
                                'debugCompleteCurrentQuest',
                                'debugGenerateTestItem',
                                'debugTeleportToFloor',
                                'debugGenerateEnemy',
                                'debugClearEnemies'
                            ];

                            let methodCount = 0;
                            debugMethods.forEach(method => {
                                if (typeof testGame[method] === 'function') {
                                    log(`✅ ${method} 方法可用`, 'success');
                                    methodCount++;
                                } else {
                                    log(`❌ ${method} 方法不存在`, 'error');
                                }
                            });

                            log(`📊 调试方法统计: ${methodCount}/${debugMethods.length} 可用`, 'info');

                        } else {
                            log('⚠️ 需要先运行游戏初始化测试', 'warning');
                        }
                    } else {
                        log('❌ addDebugMethodsToGame 函数不存在', 'error');
                    }
                } catch (error) {
                    log(`❌ 调试方法测试异常: ${error.message}`, 'error');
                }
            });
        }

        async function triggerTestEvent() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始触发测试事件...', 'info');

                try {
                    const response = await fetch('/api/test/trigger-event', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            event_type: 'test',
                            test_data: '这是一个测试事件'
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            log('✅ 测试事件触发成功', 'success');
                            log(`🎭 事件类型: ${result.event_type || '未知'}`, 'info');
                            log(`📝 事件结果: ${result.event_result || '无'}`, 'info');
                        } else {
                            log(`❌ 测试事件触发失败: ${result.message}`, 'error');
                        }
                    } else {
                        log(`❌ 测试事件请求失败: HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`❌ 测试事件触发异常: ${error.message}`, 'error');
                }
            });
        }

        async function showGameState() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始显示游戏状态...', 'info');

                try {
                    if (testGame && testGame.gameState) {
                        const gameState = testGame.gameState;
                        log('✅ 游戏状态获取成功', 'success');
                        log(`👤 玩家: ${gameState.player?.name || '未知'}`, 'info');
                        log(`📍 位置: ${gameState.player?.position || '未知'}`, 'info');
                        log(`🗺️ 当前地图: ${gameState.current_map?.name || '未知'}`, 'info');
                        log(`📜 活跃任务: ${gameState.quests?.find(q => q.is_active)?.title || '无'}`, 'info');
                    } else {
                        log('⚠️ 游戏状态不可用，请先开始游戏', 'warning');

                        // 尝试从服务器获取游戏状态
                        const response = await fetch('/api/test/game-state');
                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                log('✅ 从服务器获取游戏状态成功', 'success');
                                log(`🎮 活跃游戏数: ${result.active_games || 0}`, 'info');
                            }
                        }
                    }
                } catch (error) {
                    log(`❌ 显示游戏状态异常: ${error.message}`, 'error');
                }
            });
        }

        // ==================== 性能与压力测试 ====================

        async function runStressTest() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始 API 压力测试...', 'warning');
                log('⚠️ 注意：此测试将发送多个并发请求', 'warning');

                const testCount = 5;
                const promises = [];

                try {
                    // 创建多个并发请求
                    for (let i = 0; i < testCount; i++) {
                        const promise = fetch('/api/test/stress-test', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                test_id: i + 1,
                                timestamp: new Date().toISOString()
                            })
                        });
                        promises.push(promise);
                    }

                    log(`🚀 发送 ${testCount} 个并发请求...`, 'info');
                    const startTime = Date.now();

                    const responses = await Promise.all(promises);
                    const endTime = Date.now();
                    const totalTime = endTime - startTime;

                    let successCount = 0;
                    let errorCount = 0;

                    for (let i = 0; i < responses.length; i++) {
                        const response = responses[i];
                        if (response.ok) {
                            successCount++;
                            log(`✅ 请求 ${i + 1} 成功 (${response.status})`, 'success');
                        } else {
                            errorCount++;
                            log(`❌ 请求 ${i + 1} 失败 (${response.status})`, 'error');
                        }
                    }

                    log(`📊 压力测试完成`, 'info');
                    log(`⏱️ 总耗时: ${totalTime}ms`, 'info');
                    log(`✅ 成功: ${successCount}/${testCount}`, 'success');
                    log(`❌ 失败: ${errorCount}/${testCount}`, errorCount > 0 ? 'error' : 'info');
                    log(`📈 平均响应时间: ${(totalTime / testCount).toFixed(2)}ms`, 'info');

                } catch (error) {
                    log(`❌ 压力测试异常: ${error.message}`, 'error');
                }
            });
        }

        // ==================== 调试强制加载测试 ====================

        async function testDebugForceLoad() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始调试强制加载测试...', 'info');

                try {
                    // 1. 先列出所有存档
                    log('📁 步骤1: 获取存档列表...', 'info');
                    const savesResponse = await fetch('/api/saves');
                    if (!savesResponse.ok) {
                        log('❌ 获取存档列表失败', 'error');
                        return;
                    }

                    const saves = await savesResponse.json();
                    if (!saves || saves.length === 0) {
                        log('⚠️ 没有找到存档，请先创建一个游戏', 'warning');
                        log('💡 提示：可以运行"游戏初始化测试"创建测试游戏', 'info');
                        return;
                    }

                    log(`✅ 找到 ${saves.length} 个存档`, 'success');

                    // 显示存档列表
                    saves.forEach((save, index) => {
                        log(`  ${index + 1}. ${save.player_name} (Lv.${save.player_level}) - ID: ${save.id}`, 'info');
                    });

                    // 2. 选择第一个存档进行测试
                    const testSave = saves[0];
                    log(`\n🎯 步骤2: 测试强制加载存档...`, 'info');
                    log(`📋 目标存档: ${testSave.player_name} (ID: ${testSave.id})`, 'info');

                    // 3. 调用调试强制加载API
                    const forceLoadResponse = await fetch('/api/debug/force-load', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            game_id: testSave.id
                        })
                    });

                    if (!forceLoadResponse.ok) {
                        const errorData = await forceLoadResponse.json();
                        log(`❌ 强制加载失败: ${errorData.detail || '未知错误'}`, 'error');
                        return;
                    }

                    const result = await forceLoadResponse.json();

                    if (result.success) {
                        log('✅ 强制加载成功！', 'success');
                        log(`📊 游戏信息:`, 'info');
                        log(`  - 游戏ID: ${result.game_id}`, 'info');
                        log(`  - 用户ID: ${result.user_id}`, 'info');
                        log(`  - 消息: ${result.message}`, 'info');

                        if (result.debug_info) {
                            log(`  - 玩家等级: ${result.debug_info.player_level}`, 'info');
                            log(`  - 回合数: ${result.debug_info.turn_count}`, 'info');
                            log(`  - 地图: ${result.debug_info.map_name} (深度${result.debug_info.map_depth})`, 'info');
                            log(`  - 活跃任务: ${result.debug_info.active_quests}`, 'info');
                        }

                        log(`\n📖 叙述: ${result.narrative}`, 'info');

                        // 4. 验证游戏状态
                        log(`\n🔍 步骤3: 验证游戏状态...`, 'info');
                        const stateResponse = await fetch(`/api/game/${result.game_id}`);

                        if (stateResponse.ok) {
                            const gameState = await stateResponse.json();
                            log('✅ 游戏状态验证成功', 'success');
                            log(`  - 玩家位置: (${gameState.player.position[0]}, ${gameState.player.position[1]})`, 'info');
                            log(`  - 地图大小: ${gameState.current_map.width}x${gameState.current_map.height}`, 'info');
                            log(`  - 怪物数量: ${gameState.monsters.length}`, 'info');
                        } else {
                            log('⚠️ 游戏状态验证失败', 'warning');
                        }

                        log('\n✅ 调试强制加载测试完成！', 'success');
                        log('💡 提示：你可以在主界面使用 /?game_id=' + result.game_id + ' 直接进入游戏', 'info');

                    } else {
                        log(`❌ 强制加载失败: ${result.message || '未知错误'}`, 'error');
                    }

                } catch (error) {
                    log(`❌ 测试异常: ${error.message}`, 'error');
                    console.error('Debug force load test error:', error);
                }
            });
        }

        async function testMemoryUsage() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始内存使用测试...', 'info');

                try {
                    // 检查浏览器内存API支持
                    if ('memory' in performance) {
                        const memory = performance.memory;
                        log('✅ 浏览器内存信息可用', 'success');
                        log(`💾 已用内存: ${(memory.usedJSHeapSize / 1024 / 1024).toFixed(2)} MB`, 'info');
                        log(`📊 总内存: ${(memory.totalJSHeapSize / 1024 / 1024).toFixed(2)} MB`, 'info');
                        log(`🔒 内存限制: ${(memory.jsHeapSizeLimit / 1024 / 1024).toFixed(2)} MB`, 'info');

                        // 计算内存使用率
                        const usagePercent = ((memory.usedJSHeapSize / memory.jsHeapSizeLimit) * 100).toFixed(2);
                        log(`📈 内存使用率: ${usagePercent}%`, usagePercent > 80 ? 'warning' : 'info');
                    } else {
                        log('⚠️ 浏览器不支持内存API', 'warning');
                    }

                    // 测试服务器内存使用
                    const response = await fetch('/api/test/memory-usage');
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            log('✅ 服务器内存信息获取成功', 'success');
                            log(`🖥️ 服务器内存使用: ${result.memory_usage || '未知'}`, 'info');
                            log(`💽 磁盘使用: ${result.disk_usage || '未知'}`, 'info');
                        }
                    }

                    // 测试对象创建和垃圾回收
                    log('🧪 测试对象创建和内存回收...', 'info');
                    const testObjects = [];
                    for (let i = 0; i < 1000; i++) {
                        testObjects.push({
                            id: i,
                            data: new Array(100).fill(Math.random()),
                            timestamp: new Date()
                        });
                    }

                    log(`📦 创建了 ${testObjects.length} 个测试对象`, 'info');

                    // 清理测试对象
                    testObjects.length = 0;

                    // 建议垃圾回收（如果支持）
                    if (window.gc) {
                        window.gc();
                        log('🗑️ 手动触发垃圾回收', 'info');
                    } else {
                        log('ℹ️ 浏览器不支持手动垃圾回收', 'info');
                    }

                } catch (error) {
                    log(`❌ 内存使用测试异常: ${error.message}`, 'error');
                }
            });
        }

        async function runFullSystemTest() {
            const button = event.target;
            await withLoadingButton(button, async () => {
                log('开始完整系统测试...', 'warning');
                log('🔄 这将运行所有主要测试功能', 'info');

                const testFunctions = [
                    { name: '基础功能检查', func: () => testBasicFunctionality() },
                    { name: '配置加载测试', func: () => testConfigLoading() },
                    { name: 'Gemini API测试', func: () => testGeminiConnection() },
                    { name: '地图生成测试', func: () => testMapGeneration() },
                    { name: '角色系统测试', func: () => testCharacterSystem() },
                    { name: '任务系统测试', func: () => testQuestSystem() },
                    { name: '物品系统测试', func: () => testItemSystem() },
                    { name: '数据保存测试', func: () => testDataSaving() },
                    { name: '数据加载测试', func: () => testDataLoading() }
                ];

                let passedTests = 0;
                let failedTests = 0;
                const startTime = Date.now();

                for (let i = 0; i < testFunctions.length; i++) {
                    const test = testFunctions[i];
                    log(`🔄 [${i + 1}/${testFunctions.length}] 运行: ${test.name}`, 'info');

                    try {
                        // 模拟按钮点击事件
                        const mockEvent = { target: button };
                        window.event = mockEvent;

                        await test.func();
                        passedTests++;
                        log(`✅ ${test.name} 完成`, 'success');
                    } catch (error) {
                        failedTests++;
                        log(`❌ ${test.name} 失败: ${error.message}`, 'error');
                    }

                    // 添加短暂延迟避免请求过于频繁
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                const endTime = Date.now();
                const totalTime = endTime - startTime;

                log('🏁 完整系统测试完成', 'info');
                log(`⏱️ 总耗时: ${(totalTime / 1000).toFixed(2)} 秒`, 'info');
                log(`✅ 通过测试: ${passedTests}/${testFunctions.length}`, 'success');
                log(`❌ 失败测试: ${failedTests}/${testFunctions.length}`, failedTests > 0 ? 'error' : 'info');

                const successRate = ((passedTests / testFunctions.length) * 100).toFixed(2);
                log(`📊 成功率: ${successRate}%`, successRate >= 80 ? 'success' : 'warning');

                if (successRate >= 90) {
                    log('🎉 系统状态优秀！', 'success');
                } else if (successRate >= 70) {
                    log('⚠️ 系统状态良好，但有改进空间', 'warning');
                } else {
                    log('🚨 系统存在较多问题，需要检查', 'error');
                }
            });
        }

        // ==================== 额外的工具函数 ====================

        function exportTestResults() {
            if (testResults.length === 0) {
                log('没有测试结果可导出', 'warning');
                return;
            }

            const exportData = {
                export_time: new Date().toISOString(),
                test_session: `test_${Date.now()}`,
                total_tests: testResults.length,
                results: testResults
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});

            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `labyrinthia_test_results_${new Date().toISOString().split('T')[0]}.json`;
            link.click();

            log('✅ 测试结果已导出', 'success');
        }

        function generateTestReport() {
            if (testResults.length === 0) {
                log('没有测试结果可生成报告', 'warning');
                return;
            }

            const successCount = testResults.filter(r => r.type === 'success').length;
            const errorCount = testResults.filter(r => r.type === 'error').length;
            const warningCount = testResults.filter(r => r.type === 'warning').length;
            const infoCount = testResults.filter(r => r.type === 'info').length;

            log('📊 测试报告生成', 'info');
            log(`📈 总测试数: ${testResults.length}`, 'info');
            log(`✅ 成功: ${successCount}`, 'success');
            log(`❌ 错误: ${errorCount}`, errorCount > 0 ? 'error' : 'info');
            log(`⚠️ 警告: ${warningCount}`, warningCount > 0 ? 'warning' : 'info');
            log(`ℹ️ 信息: ${infoCount}`, 'info');

            const successRate = ((successCount / (successCount + errorCount)) * 100).toFixed(2);
            log(`📊 成功率: ${successRate}%`, successRate >= 80 ? 'success' : 'warning');

            // 显示最近的错误
            const recentErrors = testResults.filter(r => r.type === 'error').slice(-3);
            if (recentErrors.length > 0) {
                log('🔍 最近的错误:', 'warning');
                recentErrors.forEach(error => {
                    log(`   ${error.message}`, 'error');
                });
            }
        }

        // 添加键盘快捷键支持
        document.addEventListener('keydown', function(event) {
            // Ctrl+R: 生成测试报告
            if (event.ctrlKey && event.key === 'r') {
                event.preventDefault();
                generateTestReport();
            }
            // Ctrl+E: 导出测试结果
            else if (event.ctrlKey && event.key === 'e') {
                event.preventDefault();
                exportTestResults();
            }
            // Ctrl+L: 清空结果
            else if (event.ctrlKey && event.key === 'l') {
                event.preventDefault();
                clearResults();
            }
        });

        // 添加右键菜单功能
        document.getElementById('results').addEventListener('contextmenu', function(event) {
            event.preventDefault();

            // 创建简单的上下文菜单
            const menu = document.createElement('div');
            menu.style.cssText = `
                position: fixed;
                top: ${event.clientY}px;
                left: ${event.clientX}px;
                background: white;
                border: 1px solid #ccc;
                border-radius: 4px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                padding: 8px 0;
                min-width: 150px;
            `;

            const menuItems = [
                { text: '生成测试报告', action: generateTestReport },
                { text: '导出测试结果', action: exportTestResults },
                { text: '清空结果', action: clearResults }
            ];

            menuItems.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.textContent = item.text;
                menuItem.style.cssText = `
                    padding: 8px 16px;
                    cursor: pointer;
                    font-size: 14px;
                `;
                menuItem.addEventListener('mouseenter', () => {
                    menuItem.style.backgroundColor = '#f0f0f0';
                });
                menuItem.addEventListener('mouseleave', () => {
                    menuItem.style.backgroundColor = 'transparent';
                });
                menuItem.addEventListener('click', () => {
                    item.action();
                    document.body.removeChild(menu);
                });
                menu.appendChild(menuItem);
            });

            document.body.appendChild(menu);

            // 点击其他地方关闭菜单
            setTimeout(() => {
                document.addEventListener('click', function closeMenu() {
                    if (document.body.contains(menu)) {
                        document.body.removeChild(menu);
                    }
                    document.removeEventListener('click', closeMenu);
                }, 100);
            });
        });

        // 覆盖定义：清理版 gateByDebugMode，避免异常字符
        function gateByDebugMode() {
            try {
                fetch('/api/config')
                    .then(res => res.json())
                    .then(payload => {
                        const cfg = payload?.config || payload;
                        const debug = cfg?.game?.debug_mode;
                        if (!debug) {
                            document.querySelectorAll('.test-btn, .clear-btn').forEach(btn => btn.disabled = true);
                            log('调试模式未启用：快速测试功能已禁用', 'warning');
                        }
                    })
                    .catch(err => {
                        log(`调试模式检测失败: ${err.message}`, 'warning');
                    });
            } catch (e) {
                log(`调试模式检测异常: ${e.message}`, 'warning');
            }
        }
</body>
</html>
