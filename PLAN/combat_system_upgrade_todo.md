# 战斗内核 2.0 分阶段详细 TODO（AC / Buff / 状态 / 装备）

> 目标：在不破坏现有可玩性的前提下，完成一次可持续演进的战斗系统升级。
> 原则：后端权威结算、前端可预测展示、数据结构前向兼容、规则可配置化。

---

## 0. 总体里程碑与治理

- [ ] 明确升级范围（包含 AC 分层、状态运行时、装备生效链、抗性体系、前后端收敛）
- [ ] 确定阶段发布策略（每阶段可独立上线，可灰度回滚）
- [ ] 建立统一术语表（命中、穿透、减伤、护盾、临时生命、易伤、免疫等）
- [ ] 明确战斗日志标准格式（用于调试、回放、QA 验证）
- [ ] 建立 schema 变更流程（数据模型新增字段必须给出默认值和迁移方案）
- [ ] 建立数值治理规范（上限、下限、乘区顺序、叠层上限）

**验收标准**
- [ ] 团队对规则词汇和计算顺序无歧义
- [ ] 每个阶段可单独验收、单独回滚

---

## 1. Phase 1：统一战斗求值层（Combat Core）

### 1.1 设计与抽象
- [ ] 定义统一攻击结算流水线：命中检定 -> 伤害构建 -> 减免吸收 -> 最终结算 -> 事件输出
- [ ] 设计 `CombatSnapshot`（战斗快照）结构：基础属性、装备加成、状态加成、地形修正、临时效果
- [ ] 设计 `DamagePacket` 结构：来源、目标、伤害类型、基值、倍率、穿透、可否暴击
- [ ] 设计 `MitigationResult` 结构：被哪些机制减免/吸收、每一步数值变化
- [ ] 设计统一结果对象：用于前端展示、日志、调试面板和回放

### 1.2 落地改造
- [ ] 将怪物回合攻击接入统一求值层（优先后端路径）
- [ ] 将玩家攻击在后端形成权威结算接口（前端先兼容，后续收敛）
- [ ] 补充“命中失败”“暴击”“免疫”“护盾吸收”等标准事件文本
- [ ] 新旧结算并行一段时间，输出对比日志（用于校验）

### 1.3 测试
- [ ] 构建黄金样例（固定种子 + 固定场景）验证结算稳定性
- [ ] 对比旧系统误差并评估体感（过强/过弱）
- [ ] 压测回合推进性能，确认不会显著增加响应延迟

**验收标准**
- [ ] 后端任意攻击都可产出完整 breakdown
- [ ] 同输入同种子结算可复现

---

## 2. Phase 2：AC 分层机制升级

### 2.1 目标模型
- [ ] 将 AC 拆分为分量：`base` / `armor` / `shield` / `status` / `situational` / `penalty`
- [ ] 定义 `ac_effective` 聚合规则与上限下限
- [ ] 定义 AC 与“减伤”边界：AC 只处理命中门槛，不再直接承担减伤语义

### 2.2 兼容策略
- [ ] 保留旧 AC 字段作为兼容读写入口，内部转为分量计算
- [ ] 存档迁移：旧存档 AC 自动落到合理分量（至少不改变体感）
- [ ] 兼容旧接口返回：前端短期仍能读取单值 AC

### 2.3 验证与平衡
- [ ] 建立不同职业/等级 AC 基线表
- [ ] 验证“高AC不再造成离谱减伤”的战斗体感
- [ ] 校验怪物命中率曲线是否符合预期

**验收标准**
- [ ] AC 语义统一（命中阈值）
- [ ] 存档迁移后可直接继续游玩且无明显断层

---

## 3. Phase 3：状态系统升级为 Effect Runtime

### 3.1 结构升级
- [ ] 扩展状态定义：持续型、触发型、一次性、光环型
- [ ] 增加状态钩子：`on_turn_start` / `on_turn_end` / `on_attack` / `on_hit` / `on_damage_taken` / `on_kill`
- [ ] 增加状态分组：互斥组（同类不叠）、覆盖组（强覆盖弱）、独立叠层组
- [ ] 增加驱散规则：可驱散类型、驱散优先级、来源追踪
- [ ] 增加快照模式与实时模式选择（避免历史回放歧义）

### 3.2 行为规则
- [ ] 统一叠层策略：replace/refresh/stack/keep_highest 的精确定义
- [ ] 统一结算顺序：伤害前修正 -> 伤害后效果 -> 回合结束 tick
- [ ] 支持控制类状态（眩晕、沉默、缴械、定身）对行动可用性的影响
- [ ] 支持 DOT/HOT 与抗性联动

### 3.3 工具与可观察性
- [ ] 增加状态调试视图：来源、剩余回合、叠层、即时贡献
- [ ] 增加状态冲突告警（互斥状态同时存在）
- [ ] 增加状态回放日志（方便定位异常）

**验收标准**
- [ ] 状态可解释（玩家可知道为何生效/失效）
- [ ] 复杂叠层场景不会出现不可预期结果

---

## 4. Phase 4：装备系统与穿着效果体系

### 4.1 装备能力模型
- [ ] 定义装备常驻词缀（属性、命中、暴击、抗性、护盾、回复）
- [ ] 定义触发词缀（受击触发、击杀触发、回合触发）
- [ ] 定义套装系统（`set_id` + 件数阈值）
- [ ] 定义稀有度成长与随机词缀范围

### 4.2 生效链路
- [ ] 装备/卸下时触发统一重算（写入战斗快照，不直接散写最终值）
- [ ] 被动装备效果与主动物品效果共用统一效果引擎
- [ ] 装备效果纳入状态系统（例如“穿戴时获得常驻状态”）
- [ ] 装备冲突处理（同槽替换、不可叠加词缀、唯一装备）

### 4.3 内容生产规范
- [ ] 规范装备词缀 schema（便于 LLM 生成与校验）
- [ ] 建立词缀白名单和数值边界（防止生成异常词条）
- [ ] 建立装备模板库（基础模板 + 稀有变体 + 套装模板）

**验收标准**
- [ ] 穿脱装备会实时影响命中/AC/伤害/抗性
- [ ] 套装触发与解除行为稳定

---

## 5. Phase 5：伤害类型、抗性与防御层

### 5.1 伤害语义扩展
- [ ] 明确伤害类型完整列表（物理细分 + 元素 + 神秘）
- [ ] 支持多类型混合伤害包（例如物理+火焰）
- [ ] 支持穿透机制（护甲穿透、抗性穿透、护盾穿透）

### 5.2 防御层顺序
- [ ] 统一顺序：命中 -> 护盾/格挡 -> 抗性/易伤 -> 最终HP变更
- [ ] 引入临时生命与护盾分层，避免语义混杂
- [ ] 引入“不可减免伤害”标记（用于特殊剧情或 Boss 技能）

### 5.3 规则可配置化
- [ ] 将关键乘区、阈值放入可配置规则集
- [ ] 建立规则版本号，允许存档绑定规则版本

**验收标准**
- [ ] 同一攻击的每层减免都有可追踪日志
- [ ] 抗性/易伤在复杂组合下仍保持一致性

---

## 6. Phase 6：前后端收敛与体验升级

### 6.1 权威收敛
- [ ] 后端成为唯一结算权威，前端仅做预测展示与动画
- [ ] 前端预测值与后端结果差异提示机制（仅调试可见）
- [ ] 最终逐步下线前端真实扣血逻辑

### 6.2 UI/交互
- [ ] 增加战斗详情面板（命中检定、加值来源、减免链）
- [ ] 增加状态条（图标、层数、剩余回合、来源）
- [ ] 增加装备词缀面板（基础词缀、触发词缀、套装进度）
- [ ] 增加“本回合生效效果”摘要（帮助理解复杂战斗）

### 6.3 调试与运营
- [ ] 调试模式展示完整求值 JSON（请求/响应）
- [ ] 建立异常战斗抓取（自动记录可复现快照）
- [ ] 建立在线平衡监控指标（胜率、平均回合、爆发峰值、死亡来源）

**验收标准**
- [ ] 玩家可解释“为什么命中/为什么减伤/为什么死亡”
- [ ] 调试人员可通过快照复现战斗结果

---

## 7. 横切任务（必须贯穿全程）

### 7.1 兼容与迁移
- [ ] 存档迁移脚本支持幂等执行
- [ ] 新字段默认值完善，旧档读取零崩溃
- [ ] 回滚策略明确（规则版本、字段降级、日志兜底）

### 7.2 测试体系
- [ ] 单元测试：命中、暴击、抗性、状态叠层、装备生效
- [ ] 集成测试：完整回合推进（玩家->怪物->状态tick）
- [ ] 回归测试：任务事件和物品效果不会破坏战斗链
- [ ] 随机测试（fuzz）：防止极端参数导致数值爆炸

### 7.3 性能与并发
- [ ] 评估每回合结算耗时，设定上限
- [ ] 避免重复构建快照造成性能浪费（可做局部缓存）
- [ ] 在异步流程中保证状态一致性与锁粒度合理

### 7.4 安全与质量
- [ ] 对 LLM 生成效果做 schema 校验与白名单过滤
- [ ] 对外部更新应用统一数值清洗
- [ ] 关键路径异常要可恢复且可观测

---

## 8. 建议推进节奏（可调整）

- [ ] Sprint A（2-3周）：完成 Phase 1 + Phase 2 核心
- [ ] Sprint B（2-3周）：完成 Phase 3 状态运行时主体
- [ ] Sprint C（2-3周）：完成 Phase 4 装备体系与词缀
- [ ] Sprint D（2周）：完成 Phase 5 抗性/防御层 + 规则可配置
- [ ] Sprint E（2周）：完成 Phase 6 前后端收敛 + 调试可视化

---

## 9. 最终上线门槛（Release Gate）

- [ ] 战斗关键场景通过率达到目标（命中/暴击/状态/装备）
- [ ] 旧存档迁移成功率达到目标
- [ ] 不出现严重数值异常（一击秒全图、负血、无限叠层）
- [ ] 调试面板可完整追踪任一战斗结果
- [ ] 出现异常时可快速回滚到上一规则版本

---

## 10. 未来预留（不阻塞当前上线）

- [ ] 职业专精树与天赋被动接入统一战斗快照
- [ ] Boss 专属机制（阶段护盾、抗性切换、破防窗口）
- [ ] 地形战斗机制（掩体、视野、地形加成）
- [ ] 组合反应系统（状态联动触发特殊效果）
- [ ] PVE 难度曲线自动调优（基于战斗统计数据）
