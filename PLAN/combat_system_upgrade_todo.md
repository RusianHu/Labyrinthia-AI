# 战斗内核 2.0 分阶段详细 TODO（AC / Buff / 状态 / 装备）

> 目标：在不破坏现有可玩性的前提下，完成一次可持续演进的战斗系统升级。
> 原则：后端权威结算、前端可预测展示、数据结构前向兼容、规则可配置化。
> 当前实现现状：即时战斗主要由前端本地引擎处理，后端承担击杀后处理与生成型逻辑；因此必须先完成“权威收敛最小闭环”。

---

## 0. 总体里程碑与治理

- [x] 明确升级范围（包含 AC 分层、状态运行时、装备生效链、抗性体系、前后端收敛）
- [x] 确定阶段发布策略（每阶段可独立上线，可灰度回滚）
- [x] 建立统一术语表（命中、穿透、减伤、护盾、临时生命、易伤、免疫等）
- [x] 明确战斗日志标准格式（用于调试、回放、QA 验证）
- [x] 建立 schema 变更流程（数据模型新增字段必须给出默认值和迁移方案）
- [x] 建立数值治理规范（上限、下限、乘区顺序、叠层上限）
- [x] 建立战斗 trace_id 贯通规范（前端动作 -> 后端 action -> 结算 -> 存档日志）
- [x] 建立前端预测值与后端权威值差异日志规范（仅调试可见）
- [x] 增加 `combat_rule_version` 规则版本字段并定义升级/回滚流程

### 0.1 升级范围（已确认）

- 战斗权威收敛：建立 `combat_authority_mode` 三档（local/hybrid/server），以服务端落账为最终真值。
- 统一战斗求值：后续 Phase 1 将收敛到统一求值流水线与标准化 breakdown 结构。
- 状态运行时：后续 Phase 3 升级到 Effect Runtime（钩子、分组、叠层、驱散、回放）。
- AC 分层：后续 Phase 2 完成 AC 分量化与兼容读写（旧字段保留入口）。
- 抗性与防御层：后续 Phase 5 明确命中/护盾/抗性/HP 顺序并支持穿透与不可减免。
- 装备生效链：后续 Phase 4 与物品栏重构协同，纳入统一效果引擎与快照写入。
- 兼容与迁移：新增字段必须提供默认值与迁移路径，旧存档可直接加载游玩。
- 观测与回滚：全链路 trace_id、差异日志、规则版本化与灰度开关全程可回退。

### 0.2 阶段发布策略（已确认）

- 发布顺序强约束：`Phase 0 -> Phase 0.5 -> Phase 1 -> Phase 3 -> Phase 2 -> Phase 5 -> Phase 4 -> Phase 6`。
- 每阶段拆为三步：`design`（协议与字段）-> `hybrid`（双轨对比）-> `stable`（权威切换与清理）。
- 灰度入口统一：后端配置开关优先（`config.py` 读取环境变量），前端仅消费服务端返回策略。
- 回滚原则：只允许向前兼容 schema；回滚时优先切换规则版本/权威模式，不回滚存档结构。
- 验收门：每阶段必须满足该阶段“验收标准”后才允许推进下一阶段 checkbox。
- 运维落地：debug 全量、生产小流量、全量三段式推进，并保留快速降级路径。

### 0.3 统一术语表（已确认）

- 命中（hit）：通过命中检定后进入伤害构建，不等于造成最终 HP 伤害。
- 未命中（miss）：命中检定失败，不进入伤害结算链。
- 暴击（critical）：命中后的伤害构建增强，不改变命中判定本身。
- 穿透（penetration）：对护甲/抗性/护盾等防御层的定向削减能力。
- 减伤（mitigation）：防御层对伤害值的降低，不包含护盾吸收。
- 护盾（shield）：优先于 HP 承伤的可消耗防御值。
- 临时生命（temporary_hp）：独立于 max_hp 的一次性生命缓冲层。
- 易伤（vulnerability）：最终乘区放大，通常与抗性互斥或按规则覆盖。
- 抗性（resistance）：对特定伤害类型按比例减免。
- 免疫（immunity）：对指定伤害或效果完全无效。
- 不可减免（true_damage）：绕过减伤/抗性的伤害标记，仍可被命中阶段约束（除非技能声明必中）。
- 权威值（authoritative_value）：服务端结算并写入存档的最终状态。
- 预测值（predicted_value）：前端用于表现和手感的临时估计值。
- 落账（settle）：将结算结果写入玩家/怪物状态并持久化。

### 0.4 战斗日志标准格式（已确认）

- 顶层字段：`timestamp`、`trace_id`、`game_id`、`user_id`、`phase`、`authority_mode`、`rule_version`。
- 动作字段：`action`、`actor_id`、`target_id`、`input_snapshot_hash`、`idempotency_key`（可选）。
- 结算字段：`predicted`（前端预测）与 `authoritative`（后端权威）双对象并列，均含 `hit`、`damage`、`death`、`exp`。
- 分解字段：`breakdown` 数组逐层记录（如命中检定、护盾吸收、抗性减免、HP 扣减），每层包含 `stage`、`before`、`after`、`delta`、`reason`。
- 并发字段：`lock_wait_ms`、`lock_hold_ms`、`operation`，用于复盘锁竞争。
- 可观测字段：`error_code`、`warning_flags`、`diff_metrics`（hybrid 模式下预测/权威差异）。
- 存储策略：debug 全量落日志，生产采样并保留异常全量；trace_id 作为检索主键。

### 0.5 schema 变更流程（已确认）

- 变更入口：所有战斗相关字段新增必须先更新数据模型与 `to_dict/from_dict`，后更新接口层与前端消费层。
- 默认值强制：新增字段必须提供显式默认值；反序列化缺省时必须回填，禁止 `KeyError` 依赖。
- 兼容顺序：先“可读旧档 + 可写新档”，再启用新逻辑；禁止一次性切断旧字段读取。
- 迁移策略：存档读取时懒迁移（load-time migration），必要时提供离线迁移脚本；迁移过程幂等。
- 双写窗口：涉及字段替换时采用“新旧字段双写、优先读新、回退读旧”，窗口结束后再清理旧字段。
- 校验与清洗：外部/LLM输入通过 schema 校验与数值清洗后再写入状态。
- 观测要求：每次 schema 版本变更记录 `combat_rule_version` 与迁移日志，失败可降级回滚。

### 0.6 数值治理规范（已确认）

- 上下限：HP/MP/经验/护盾/临时生命等关键值统一执行 clamp，禁止负值与溢出写回。
- 命中链顺序：命中检定 -> 暴击判定 -> 伤害基值构建 -> 防御层处理 -> 最终落账。
- 防御层顺序：护盾 -> 临时生命 -> 抗性/易伤 -> HP（后续 Phase 5 细化类型穿透）。
- 乘区顺序：基础值加法层 -> 百分比增减层 -> 末端乘区（暴击/易伤）-> 最小伤害保护。
- 叠层上限：状态叠层必须声明 `max_stacks`，超限按策略（replace/refresh/stack/keep_highest）处理。
- 四舍五入：服务端统一采用确定性取整策略（默认向下取整，特殊规则显式声明）。
- 异常保护：任一步骤出现 NaN/Inf/异常值时回退安全默认并记录告警日志。

**验收标准**
- [ ] 团队对规则词汇和计算顺序无歧义
- [x] 每个阶段可单独验收、单独回滚
- [x] 任一战斗可通过 trace_id 串起完整链路

### 0.7 trace_id 贯通规范（已确认）

- 生成源：前端每次战斗动作生成 `client_trace_id`；服务端 `/api/action` 生成 `trace_id` 并回传。
- 传递链：`client_action -> /api/action -> combat_result/event_choice/sync_state -> save log` 全链路透传。
- 关联键：`trace_id` + `game_id` + `turn_count` + `action` 形成唯一追踪上下文。
- 子链路：怪物死亡结算、任务推进、事件选择等子流程生成 `span_id` 并挂接父 `trace_id`。
- 错误规范：异常响应必须携带 `trace_id` 与 `error_code`，日志可一键定位。

### 0.8 预测/权威差异日志规范（已确认）

- 生效范围：仅 `combat_authority_mode=hybrid` 且 debug 打开时记录详细差异。
- 核心字段：`trace_id`、`entity_id`、`metric`（hit/damage/death/exp）、`predicted`、`authoritative`、`delta`。
- 输出策略：前端控制台展示简版，后端结构化日志落盘全量，便于回放对比。
- 阈值策略：超阈值差异打 `warning_flags` 并写统计指标，用于灰度闸门。

### 0.9 combat_rule_version 版本化流程（已确认）

- 字段定义：`combat_rule_version` 加入游戏状态根字段，默认值 `1`（兼容旧档自动回填）。
- 读写策略：读档缺失时回填默认并记录迁移日志；写档始终带版本号。
- 升级流程：`vN -> vN+1` 先启用兼容读取，再灰度切换规则，最后清理旧路径。
- 回滚流程：优先切换规则解释器到上一版本，不回滚存档结构；必要时启用降级读取适配。
- 校验要求：版本切换必须有金样例回归与差异率阈值检查。

---

## 0.5. Phase 0.5（前置强制）：权威收敛最小闭环

### 0.5.1 运行权威划分
- [x] 明确“前端仅预测展示、后端唯一权威落账”的边界文档
- [x] 保留前端本地预测动画与手感，但取消前端最终状态写死（HP/经验/击杀）
- [x] 攻击与受击都统一走后端权威返回，前端仅应用结果并做特效

#### 0.5.1.B 前端去落账化（已确认）

- 新增前端权威模式判定：`local` 保持旧行为，`hybrid/server` 禁止前端直接写死战斗最终值。
- 玩家攻击：在 `hybrid/server` 下前端不再本地扣怪物 HP，不再本地决定击杀，改为走 `/api/action(attack)`。
- 怪物攻击：在 `hybrid/server` 下前端跳过 `processMonsterTurns` 与本地 HP 扣减，避免双端分叉。
- 击杀异常兜底：`hybrid/server` 下 `combat-result` 失败不再本地补写经验/升级，仅提示错误并等待后端结果。

#### 0.5.1.A 前后端权威边界（已确认）

- 前端（预测层）职责：负责输入采集、可达性判定、动画与特效表现、临时预测值显示，不作为最终落账来源。
- 后端（权威层）职责：负责攻击/受击结算、经验与击杀落账、任务推进、存档持久化；任何冲突以后端返回为准。
- 状态写入原则：HP/经验/击杀/死亡标志仅允许后端权威接口写入，前端只能“应用服务端结果”。
- 同步原则：`/api/sync-state` 仅允许同步“计算型字段”（位置、地图可见性等）；生成型字段继续由后端保持权威。
- 兼容原则：保留旧动作入口（`/api/action`、`/api/game/{game_id}/combat-result`）作为过渡兜底，避免旧客户端硬断。

### 0.5.2 双轨过渡与灰度
- [x] 增加开关：`combat_authority_mode`（local / hybrid / server）
- [x] 在 hybrid 期输出新旧结算差异日志（命中、伤害、死亡、经验）
- [x] 定义差异阈值告警（超过阈值自动打点）

### 0.5.3 兼容与稳定
- [x] 兼容旧客户端（保留后端兜底攻击接口）
- [x] 关键动作幂等化（attack/use_item/combat_result）
- [x] 锁粒度与并发路径复核（action/sync-state/combat-result/event-choice）

**验收标准**
- [x] 战斗最终结果以服务端为准，不再出现双端状态分叉
- [x] 前端预测与后端结果可观测、可比对、可回放

---

## 1. Phase 1：统一战斗求值层（Combat Core）

### 1.1 设计与抽象
- [ ] 定义统一攻击结算流水线：命中检定 -> 伤害构建 -> 减免吸收 -> 最终结算 -> 事件输出
- [ ] 设计 `CombatSnapshot`（战斗快照）结构：基础属性、装备加成、状态加成、地形修正、临时效果
- [ ] 设计 `DamagePacket` 结构：来源、目标、伤害类型、基值、倍率、穿透、可否暴击
- [ ] 设计 `MitigationResult` 结构：被哪些机制减免/吸收、每一步数值变化
- [ ] 设计统一结果对象：用于前端展示、日志、调试面板和回放

### 1.2 落地改造
- [ ] 将怪物回合攻击接入统一求值层
- [ ] 将玩家攻击在后端形成权威结算接口
- [ ] 补充“命中失败”“暴击”“免疫”“护盾吸收”等标准事件文本
- [ ] 新旧结算并行一段时间，输出对比日志（用于校验）

### 1.3 测试
- [ ] 构建黄金样例（固定种子 + 固定场景）验证结算稳定性
- [ ] 对比旧系统误差并评估体感（过强/过弱）
- [ ] 压测回合推进性能，确认不会显著增加响应延迟

**验收标准**
- [ ] 后端任意攻击都可产出完整 breakdown
- [ ] 同输入同种子结算可复现

---

## 2. Phase 3：状态系统升级为 Effect Runtime（前置于 AC/抗性细化）

### 2.1 结构升级
- [ ] 扩展状态定义：持续型、触发型、一次性、光环型
- [ ] 增加状态钩子：`on_turn_start` / `on_turn_end` / `on_attack` / `on_hit` / `on_damage_taken` / `on_kill`
- [ ] 增加状态分组：互斥组（同类不叠）、覆盖组（强覆盖弱）、独立叠层组
- [ ] 增加驱散规则：可驱散类型、驱散优先级、来源追踪
- [ ] 增加快照模式与实时模式选择（避免历史回放歧义）

### 2.2 行为规则
- [ ] 统一叠层策略：replace/refresh/stack/keep_highest 的精确定义
- [ ] 统一结算顺序：伤害前修正 -> 伤害后效果 -> 回合结束 tick
- [ ] 支持控制类状态（眩晕、沉默、缴械、定身）对行动可用性的影响
- [ ] 支持 DOT/HOT 与抗性联动

### 2.3 工具与可观察性
- [ ] 增加状态调试视图：来源、剩余回合、叠层、即时贡献
- [ ] 增加状态冲突告警（互斥状态同时存在）
- [ ] 增加状态回放日志（方便定位异常）

**验收标准**
- [ ] 状态可解释（玩家可知道为何生效/失效）
- [ ] 复杂叠层场景不会出现不可预期结果

---

## 3. Phase 2：AC 分层机制升级（在统一求值层稳定后）

### 3.1 目标模型
- [ ] 将 AC 拆分为分量：`base` / `armor` / `shield` / `status` / `situational` / `penalty` 等合理的值
- [ ] 定义 `ac_effective` 聚合规则与上限下限
- [ ] 定义 AC 与“减伤”边界：AC 只处理命中门槛，不再直接承担减伤语义

### 3.2 兼容策略
- [ ] 保留旧 AC 字段作为兼容读写入口，内部转为分量计算
- [ ] 存档迁移：旧存档 AC 自动落到合理分量（至少不改变体感）
- [ ] 兼容旧接口返回：前端短期仍能读取单值 AC

### 3.3 验证与平衡
- [ ] 建立不同职业/等级 AC 基线表
- [ ] 验证“高AC不再造成离谱减伤”的战斗体感
- [ ] 校验怪物命中率曲线是否符合预期

**验收标准**
- [ ] AC 语义统一（命中阈值）
- [ ] 存档迁移后可直接继续游玩且无明显断层

---

## 4. Phase 5：伤害类型、抗性与防御层

### 4.1 伤害语义扩展
- [ ] 明确伤害类型完整列表（物理细分 + 元素 + 神秘）
- [ ] 支持多类型混合伤害包（例如物理+火焰）
- [ ] 支持穿透机制（护甲穿透、抗性穿透、护盾穿透）

### 4.2 防御层顺序
- [ ] 统一顺序：命中 -> 护盾/格挡 -> 抗性/易伤 -> 最终HP变更
- [ ] 引入临时生命与护盾分层，避免语义混杂
- [ ] 引入“不可减免伤害”标记（用于特殊剧情或 Boss 技能）

### 4.3 规则可配置化
- [ ] 将关键乘区、阈值放入可配置规则集
- [ ] 建立规则版本号，允许存档绑定规则版本

**验收标准**
- [ ] 同一攻击的每层减免都有可追踪日志
- [ ] 抗性/易伤在复杂组合下仍保持一致性

---

## 5. Phase 4：装备系统与穿着效果体系（与物品栏重构协同推进）

### 5.1 装备能力模型
- [ ] 定义装备常驻词缀（属性、命中、暴击、抗性、护盾、回复）
- [ ] 定义触发词缀（受击触发、击杀触发、回合触发）
- [ ] 定义套装系统（`set_id` + 件数阈值）
- [ ] 定义稀有度成长与随机词缀范围

### 5.2 生效链路
- [ ] 装备/卸下时触发统一重算（写入战斗快照，不直接散写最终值）
- [ ] 被动装备效果与主动物品效果共用统一效果引擎
- [ ] 装备效果纳入状态系统（例如“穿戴时获得常驻状态”）
- [ ] 装备冲突处理（同槽替换、不可叠加词缀、唯一装备）

### 5.3 内容生产规范
- [ ] 规范装备词缀 schema（便于 LLM 生成与校验）
- [ ] 建立词缀白名单和数值边界（防止生成异常词条）
- [ ] 建立装备模板库（基础模板 + 稀有变体 + 套装模板）

**验收标准**
- [ ] 穿脱装备会实时影响命中/AC/伤害/抗性
- [ ] 套装触发与解除行为稳定

---

## 6. Phase 6：体验升级、调试与运营

### 6.1 UI/交互
- [ ] 增加战斗详情面板（命中检定、加值来源、减免链）
- [ ] 增加状态条（图标、层数、剩余回合、来源）
- [ ] 增加装备词缀面板（基础词缀、触发词缀、套装进度）
- [ ] 增加“本回合生效效果”摘要（帮助理解复杂战斗）

### 6.2 调试与运营
- [ ] 调试模式展示完整求值 JSON（请求/响应）
- [ ] 建立异常战斗抓取（自动记录可复现快照）
- [ ] 建立在线平衡监控指标（胜率、平均回合、爆发峰值、死亡来源）

### 6.3 发布策略
- [ ] 分阶段灰度：先 debug 模式、再小流量、再全量
- [ ] 异常自动降级：可快速回退到上一规则版本

**验收标准**
- [ ] 玩家可解释“为什么命中/为什么减伤/为什么死亡”
- [ ] 调试人员可通过快照复现战斗结果

---

## 7. 横切任务（必须贯穿全程）

### 7.1 兼容与迁移
- [x] 新字段默认值完善，旧档读取零崩溃
- [ ] 回滚策略明确（规则版本、字段降级、日志兜底）
- [x] 新增 `combat_rule_version` 的迁移链和降级路径

### 7.2 测试体系
- [ ] 单元测试：命中、暴击、抗性、状态叠层、装备生效
- [ ] 集成测试：完整回合推进（玩家 -> 怪物 -> 状态tick）
- [ ] 回归测试：任务事件和物品效果不会破坏战斗链
- [ ] 随机测试（fuzz）：防止极端参数导致数值爆炸
- [ ] 一致性测试：前端预测 vs 后端权威（同输入同种子）

### 7.3 性能与并发
- [ ] 评估每回合结算耗时，设定上限
- [ ] 避免重复构建快照造成性能浪费（可做局部缓存）
- [ ] 在异步流程中保证状态一致性与锁粒度合理
- [ ] 建立 P50/P95 战斗结算耗时指标

### 7.4 安全与质量
- [ ] 对 LLM 生成效果做 schema 校验与白名单过滤
- [ ] 对外部更新应用统一数值清洗
- [ ] 关键路径异常要可恢复且可观测
- [ ] 关键动作必须携带 trace_id 与错误码

---

## 8. 建议推进节奏（调整后，可按资源微调）

- [ ] Sprint A（1-2周）：完成 Phase 0 + Phase 0.5（权威收敛最小闭环）
- [ ] Sprint B（2周）：完成 Phase 1（统一求值层）
- [ ] Sprint C（2周）：完成 Phase 3（状态运行时主体）
- [ ] Sprint D（1-2周）：完成 Phase 2（AC分层） + Phase 5（抗性/防御层核心）
- [ ] Sprint E（2周）：完成 Phase 4（装备体系） + Phase 6（体验与调试可视化）

---

## 9. 最终上线门槛（Release Gate）

- [ ] 战斗关键场景通过率达到目标（命中/暴击/状态/装备）
- [ ] 旧存档迁移成功率达到目标
- [ ] 不出现严重数值异常（一击秒全图、负血、无限叠层）
- [ ] 调试面板可完整追踪任一战斗结果
- [ ] 出现异常时可快速回滚到上一规则版本
- [ ] 前端预测与后端权威差异率低于目标阈值
