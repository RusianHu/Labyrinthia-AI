# 物品栏重构规划（分阶段详细版，去路径依赖）

> 说明
> - 本文档仅定义“目标、约束、实施与验收”，不强制绑定任何具体文件名、模块名或目录结构。
> - 适用于并行开发场景，避免因代码迁移/拆分导致规划失效。
> - 所有阶段均应包含：完成定义（DoD）、回归范围、风险与回滚策略。

## 阶段 0：立项与范围冻结（必须先完成）

### 0.1 目标定义
- [x] 确定一期目标：背包可用、装备可用、状态可读（持续效果可见）、交互可追踪。
- [x] 确定二期候选：交易、锻造、词条重铸、套装、掉落规则高级化。
- [x] 明确一期“不做项”，建立需求冻结窗口，防止需求膨胀。

### 0.2 约束与边界
- [x] 定义性能预算：100+ 物品可稳定渲染、筛选、排序与详情查看。
- [x] 定义终端边界：桌面与移动端最低支持能力、交互降级策略。
- [x] 定义稳定性目标：阻断级错误为 0，高频重复日志为 0。
- [x] 定义一致性目标：同一动作在所有入口语义一致、结果一致。

### 0.3 数据语义基线
- [x] 建立字段语义表：物品类型、稀有度、装备槽、充能、冷却、持续效果、任务锁定。
- [x] 建立动作语义表：使用、装备、卸下、丢弃、筛选、排序、对比。
- [x] 建立状态流转图：拾取→入包→装备/使用→回合推进→存档→读档。

---

## 阶段 0.5：后端契约冻结（前置，强制）

### 0.5.1 动作返回协议统一
- [x] 定义统一返回结构：结果、原因、影响摘要、可追踪标识、是否可重试。
- [x] 定义错误分级与错误码：可恢复/不可恢复、前端展示策略。
- [x] 定义日志最小集合：一次异常仅记录一次，并包含必要上下文。

### 0.5.2 物品状态机与幂等规则
- [x] 定义物品状态机：在包中、已装备、冷却中、已消耗、已丢弃等。
- [x] 定义幂等规则：重复请求不重复扣资源、不重复消费、不污染状态。
- [x] 定义失败保护：动作失败不扣充能、不触发冷却、不改变关键状态。

### 0.5.3 任务物品保护策略
- [x] 定义任务物品的锁定条件、解锁条件、可见提示与恢复路径。
- [x] 定义危险动作防护：二次确认、短时撤销、审计日志可复盘。

---

## 阶段 1：信息架构与交互规范（先设计再实现）

### 1.1 界面信息架构
- [x] 设计四区结构：背包区、装备区、详情区、操作区。
- [x] 定义桌面布局：多栏并行，操作与详情可同时观察。
- [x] 定义移动布局：分层抽屉/弹层，关键动作单手可达。

### 1.2 交互模型
- [x] 统一点击规则：单击查看、双击快捷操作、长按二级动作。
- [x] 定义拖拽规则：有效槽位可放置、无效槽位明确拒绝反馈。
- [x] 定义冲突提示优先级：冷却中、充能不足、任务锁定、槽位冲突。

### 1.3 视觉与文案规范
- [x] 定义稀有度视觉：颜色、边框、光效层级。
- [x] 定义状态徽标：已装备、冷却中、可充能、任务锁定、持续效果来源。
- [x] 定义文案模板：成功、失败、不可操作、回滚结果，中文且可追踪。

---

## 阶段 2：主功能 MVP（背包 + 装备 + 详情 + 操作）

### 2.1 背包渲染能力
- [x] 空槽与占位规则清晰，避免布局跳动。
- [x] 物品卡片展示：名称缩略、类型标记、稀有度、充能、冷却、锁定态。
- [x] 大背包支持：分页/虚拟列表/懒加载至少一种，满足性能预算。

### 2.2 装备系统可视化
- [x] 装备槽可视化：武器、防具、饰品槽等。
- [x] 已装备状态高亮，并显示槽位占用来源。
- [x] 支持装备/卸下直接操作与即时反馈。

### 2.3 详情与操作面板
- [x] 详情展示：完整描述、效果分解、触发条件、持续回合、代价。
- [x] 操作统一：使用、装备、卸下、丢弃、筛选、排序。
- [x] 禁用态清晰：给出具体原因与恢复条件。

### 2.4 筛选排序与对比
- [x] 筛选：类型、稀有度、可装备、冷却状态、任务锁定。
- [x] 排序：价值、最近获得、名称、稀有度。
- [x] 对比：当前装备 vs 候选装备，展示差异与机会成本。

---

## 阶段 3：规则一致性与安全保护

### 3.1 语义一致
- [x] “使用”和“装备”入口行为一致，避免重复执行与冲突。
- [x] 全部动作都返回统一结构并可追踪。

### 3.2 边界保护
- [x] 非法槽位自动回退并提示。
- [x] 冷却与充能边界保护：不出现负数、越界、错误扣减。
- [x] 幂等保护：重复操作不导致状态错乱。
- [x] 失败保护：失败不扣资源、不污染状态。

### 3.3 持续效果可视化
- [x] 展示 buff/debuff：剩余回合、层数、触发时机。
- [x] 展示预计影响：每回合变化与阶段变化。
- [x] 与来源关联：可定位到装备/物品/事件。

### 3.4 任务物品保护
- [x] 任务物品默认禁止误丢弃。
- [x] 危险操作二次确认，支持短时撤销。

---

## 阶段 4：存档兼容与数据治理

### 4.1 兼容迁移
- [x] 引入存档版本标识，建立版本迁移链。
- [x] 旧存档缺字段自动补齐，新字段读写一致。
- [x] 跨版本加载不丢关键状态（装备、充能、冷却、持续效果）。

### 4.2 数据校验
- [x] 所有入口执行字段合法性校验。
- [x] 非法数据自动降级并记录诊断信息。
- [x] 异常可复盘：具备上下文标识与最小必要日志。

### 4.3 观测与审计
- [x] 建立关键动作审计点：使用/装备/卸下/丢弃/回滚。
- [x] 建立错误统计口径：按动作、错误码、影响范围聚合。

---

## 阶段 5：测试、回归与稳定性

### 5.1 专项功能测试
- [x] 覆盖：装备/卸下、槽位冲突、冷却推进、充能耗尽、持续效果衰减。
- [x] 覆盖：任务物品保护、危险操作确认与撤销。
- [x] 覆盖：幂等重放与失败回滚。

### 5.2 端到端回归
- [x] 全链路：新建→获取→装备→换装→回合推进→存档→读档一致。
- [x] 多角色/多稀有度/多类型组合回归。

### 5.3 压力与健壮性
- [x] 大背包压力：100+ 物品渲染、筛选、排序、详情响应稳定。
- [x] 增量刷新稳定：状态更新不破坏交互绑定。
- [x] 错误治理：重复噪音日志消除，异常按规则记录。

---

## 阶段 6：灰度发布与验收交付

### 6.1 灰度策略
- [x] 先在调试开关下小范围验证，形成问题-修复闭环。
- [x] 达到门槛后逐步全量启用，并监控关键指标。

### 6.2 一期验收门槛
- [x] 核心功能通过率 100%。
- [x] 阻断级缺陷 0。
- [x] 关键回归脚本全部通过。
- [x] 移动端主路径可用。
- [x] 控制台无高频重复错误。

### 6.3 交付物
- [x] 实施总结（完成项/未完成项/风险项）。
- [x] 测试报告（覆盖、结果、遗留问题）。
- [x] 回滚预案与二期建议（可直接进入下一轮评审）。

---

## 附录 A：执行纪律（防返工）
- [x] 未完成阶段 0.5 前，不进入复杂交互实现（拖拽、长按、多态快捷操作）。
- [x] 任何新增动作，先补语义与返回协议，再补 UI。
- [x] 任何状态字段变更，先补迁移策略与回归用例，再上线。
- [x] 任何异常修复，必须附带“如何复现 + 如何验证 + 如何防回归”。
