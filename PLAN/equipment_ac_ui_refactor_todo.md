# 装备系统与 AC/UI 重构总规划 TODO（仅规划，不执行）

> 目标：把当前“装备仅切槽位展示”的半实现状态，升级为“后端数值权威 + 前端可解释展示 + 存档可迁移 + 调试可追踪”的完整系统。
>
> 约束：本清单只用于规划与排期，不代表已实施。

---

## 总体原则

- [ ] 保持后端为唯一数值真源（前端仅展示，不做最终判定）
- [ ] 装备效果全链路可解释（来源、叠加、回滚、日志）
- [ ] 兼容旧存档与旧物品结构（平滑迁移，不炸档）
- [ ] 每个阶段都可独立验收与回滚
- [ ] 优先保证“玩家看得见变化、战斗算得出变化”

---

## P0：现状冻结与观测基线（研究阶段）

### P0.1 范围冻结
- [ ] 冻结装备相关核心文件改动窗口（避免规划期间并发改坏）
- [ ] 记录当前行为基线：装备/卸下前后 AC、命中、伤害、日志、UI
- [ ] 建立“现状问题矩阵”：展示变化、战斗变化、存档变化三维对照

### P0.2 可观测性准备
- [ ] 增加调试开关：打印装备计算 trace（输入 -> 中间层 -> 输出）
- [ ] 定义统一埋点字段（game_id、turn、item_id、slot、trace_id）
- [ ] 定义最小验收数据样本（至少 10 种装备组合）

### P0.3 风险清单
- [ ] 标注高风险点：装备切换并发、重复叠加、卸下回滚失败、旧档字段缺失
- [ ] 标注中风险点：词缀条件判定、套装阈值计算、前端状态滞后
- [ ] 标注低风险点：文案、样式、动效

---

## P1：数据模型标准化（后端基础）

### P1.1 Item 结构标准化
- [ ] 定义 `equip_passive_effects` 统一 schema（type/value/condition/stack_rule/source）
- [ ] 定义 `affixes` 统一 schema（prefix/suffix/trigger/value/scaling）
- [ ] 定义 `set_thresholds` 统一 schema（2/3/4 件效果）
- [ ] 定义 `equip_requirements`（等级、职业、属性门槛）
- [ ] 定义 `item_power_score`（平衡校验用）

### P1.2 Character/Stats 结构强化
- [ ] 明确 `stats` 为“基础+可持久化”层
- [ ] 新增 `runtime_stats`/`derived_runtime` 为“战斗即时层”（可不持久化）
- [ ] AC 组件扩展并规范来源（base/dex/armor/shield/enchant/status/situational/penalty）

### P1.3 兼容策略
- [ ] 缺字段旧物品自动补默认值
- [ ] 文本型旧词条映射为结构化（映射失败时降级并告警）
- [ ] 兼容层明确生命周期（何时删除、何时强制迁移）

---

## P2：装备数值引擎（权威计算层）

### P2.1 引擎设计
- [ ] 新建 EquipmentStatPipeline（输入角色+装备+状态，输出 runtime）
- [ ] 统一聚合顺序：基础属性 -> 装备被动 -> 词缀 -> 套装 -> 状态 -> 场景修正
- [ ] 定义冲突规则（互斥、覆盖、堆叠、取最大）

### P2.2 装备动作接入
- [ ] 装备/卸下动作统一走 `apply_equipment_state_change()`
- [ ] 卸下必须可逆回滚（按 source 精确撤销，不全量重置）
- [ ] 非法装备（槽位/需求不满足）给出结构化错误与 UI 反馈

### P2.3 战斗系统接入
- [ ] 命中检定读取 runtime hit_bonus
- [ ] 伤害计算读取 runtime damage_bonus/penetration
- [ ] 防御结算读取 runtime ac/resistance/vulnerability
- [ ] 暴击与触发词缀接入统一触发管线

---

## P3：效果系统统一（主动/被动/触发）

### P3.1 EffectEngine 扩展
- [ ] effect_scope 支持：active_use / equip_passive / trigger
- [ ] 可逆效果接口：apply/revert
- [ ] source 规范：`equip:<slot>:<item_id>`、`item_use:<item_id>`

### P3.2 Active Effects 生命周期
- [ ] 入场（装备时）创建状态效果
- [ ] 回合推进（duration/stacks）更新
- [ ] 离场（卸下/驱散）精准移除
- [ ] 防重复叠加与脏状态清理

### P3.3 套装与触发器
- [ ] 套装计数实时更新
- [ ] 阈值效果自动激活/失活
- [ ] 触发器接入战斗事件总线（命中、受击、击杀、回合开始/结束）

---

## P4：前端 UI 重构（可视化与可解释）

### P4.1 角色面板
- [ ] 新增“本回合有效属性”区块
- [ ] 展示 AC 分解（基础/装备/状态）
- [ ] 展示命中、伤害、抗性来源摘要

### P4.2 物品栏与详情
- [ ] 详情区新增“装备前后对比”（如 AC 12 -> 15）
- [ ] 展示词缀与套装贡献明细
- [ ] 展示生效来源与剩余持续回合

### P4.3 装备区交互
- [ ] 每个槽位展示关键增益徽标（AC/命中/伤害）
- [ ] hover 展开完整效果树
- [ ] 装备/卸下后增加轻量反馈动画与日志提示

### P4.4 性能与稳定
- [ ] 保持增量更新，不引入地图整树重建
- [ ] 避免闭包读取旧状态（按最新 gameState 取值）
- [ ] 与现有遮罩/特效节奏对齐

---

## P5：存档迁移与兼容

### P5.1 版本化
- [ ] 新增 `equipment_schema_version`
- [ ] Load 时按版本迁移，Save 时写入最新版本
- [ ] 迁移过程可观测（日志+统计）

### P5.2 迁移实现
- [ ] 旧装备字段补全
- [ ] 旧 active_effects 规范化
- [ ] 旧 AC 字段与 components 对齐
- [ ] 异常数据隔离与修复策略（不阻塞加载）

### P5.3 回滚策略
- [ ] 迁移前自动备份
- [ ] 提供单档回滚与批量回滚开关
- [ ] 失败档标注并保留原始数据

---

## P6：平衡性与生成质量（LLM 协同）

### P6.1 物品平衡校验器
- [ ] 根据等级段和稀有度约束数值上限/下限
- [ ] 对极端词缀组合进行拒绝或削峰
- [ ] 生成后自动评分并记录

### P6.2 LLM 输出结构约束
- [ ] 强制返回结构化 JSON（schema 验证）
- [ ] 不合规响应自动重试（限制次数）
- [ ] 多次失败回退到安全模板

### P6.3 任务节奏联动
- [ ] 装备强度与任务阶段挂钩
- [ ] Boss 前后掉落权重动态调整
- [ ] 任务关键装备支持剧情锁与解锁反馈

---

## P7：测试体系与验收

### P7.1 单元测试
- [ ] 装备应用/回滚
- [ ] AC 组件聚合
- [ ] 词缀冲突与堆叠
- [ ] 套装阈值激活/失活

### P7.2 集成测试
- [ ] 装备 -> 战斗命中变化链路
- [ ] 装备 -> 伤害变化链路
- [ ] 装备 -> UI对比展示链路
- [ ] 存档读写 + 迁移一致性

### P7.3 回归与压测
- [ ] 高频换装压测（并发、回合推进）
- [ ] 长局游戏稳定性（状态清理泄漏）
- [ ] 多次读档重载一致性

### P7.4 验收标准（DoD）
- [ ] 玩家可直观看到“装备后属性变化”
- [ ] 战斗结果与装备增益严格一致
- [ ] 卸下后可逆回滚无残留
- [ ] 旧档可加载、可游玩、可保存

---

## P8：发布与运维策略

### P8.1 灰度发布
- [ ] 以 feature flag 控制新装备引擎
- [ ] 小流量验证后逐步放量
- [ ] 异常自动降级回旧逻辑

### P8.2 运行监控
- [ ] 关键指标：装备动作成功率、回滚成功率、战斗偏差率、迁移失败率
- [ ] 错误分层报警：数据异常/逻辑异常/性能异常
- [ ] 调试面板输出 trace 快照

### P8.3 发布后清理
- [ ] 清理临时兼容代码（按版本窗口）
- [ ] 固化文档与 schema 样例
- [ ] 复盘并更新下一轮规划

---

## 里程碑与排期（建议）

- [ ] M1（1-2 周）：P0 + P1 完成，模型与兼容设计冻结
- [ ] M2（2-4 周）：P2 + P3 完成，后端数值链路闭环
- [ ] M3（1-2 周）：P4 完成，前端可解释展示上线
- [ ] M4（1-2 周）：P5 + P7 完成，迁移与测试通过
- [ ] M5（1 周）：P6 + P8 完成，灰度发布与监控稳定

---

## 依赖与协作清单

- [ ] 后端：数值引擎、效果系统、存档迁移
- [ ] 前端：面板重构、装备详情、动效反馈
- [ ] 测试：自动化与回归脚本
- [ ] 内容：LLM 模板与掉落平衡规则
- [ ] 运维：灰度开关、日志与监控

---

## 变更控制

- [ ] 任何 schema 变更必须更新版本号与迁移逻辑
- [ ] 任何战斗口径变更必须补充回归样例
- [ ] 任何 UI 字段变更必须同步接口契约
- [ ] 未通过 DoD 前不得移除旧链路兜底
